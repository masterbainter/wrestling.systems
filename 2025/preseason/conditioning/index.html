<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Workout Builder</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Using Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #0E121B; /* Very dark background */
            color: #F9FAFB; /* Light text */
        }

        /* Custom color variables */
        :root {
            --bg-dark: #0E121B;
            --card-bg: #1A1F2B; /* Darker card background */
            --border-glow: #F6AD05; /* Amber glow from the image */
            --primary-text: #F6AD05; /* Amber text for titles/accents */
            --secondary-text: #A0AEC0; /* Grayish text */
            --input-bg: #2D3748; /* Darker input background */
            --button-bg: #F6AD05; /* Amber button */
            --button-text: #0E121B; /* Dark text on amber button */
            --hover-button-bg: #D97706; /* Darker amber for hover */
            --remove-button-bg: #EF4444; /* Red for remove */
            --remove-button-hover: #DC2626; /* Darker red for remove hover */

            /* Golden glow for title */
            --golden-text: #FFD700; /* Gold color */
            --golden-glow-light: #FFEA00; /* Lighter gold for inner glow */
            --golden-glow-strong: #FFA500; /* Orange-gold for outer glow */
        }

        /* Main container for centering */
        .main-container {
            width: 100%;
            max-width: 32rem; /* 512px */
            margin-left: auto;
            margin-right: auto;
            padding: 1.5rem; /* p-6 */
        }

        /* Main app card styling with glow */
        .app-card {
            background-color: var(--card-bg);
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2.5rem; /* p-10 */
            /* Toned down glow */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2), 0 0 5px rgba(255, 215, 0, 0.3) inset; 
            border: 1px solid rgba(255, 215, 0, 0.15); /* Subtle golden border */
        }

        /* Titles */
        .h1-main {
            font-weight: 900; /* Extra bold */
            color: var(--golden-text); /* Golden color */
            text-align: center;
            font-size: 3rem; /* 48px */
            margin-bottom: 0.25rem; /* mb-1 */
            letter-spacing: -0.05em; /* Tighter letter spacing */
            /* Toned down text glow */
            text-shadow: 
                0 0 5px rgba(255, 234, 0, 0.5), /* Inner glow */
                0 0 10px rgba(255, 165, 0, 0.4); /* Outer glow */
        }
        .h2-sub {
            font-weight: 700; /* Bold */
            color: var(--golden-text); /* Also golden for consistency */
            text-align: center;
            font-size: 1.5rem; /* 24px */
            margin-bottom: 2rem; /* mb-8 */
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.2); /* Subtle glow */
        }
        .section-title {
            font-weight: 700;
            color: #F9FAFB;
            font-size: 1.125rem; /* lg */
            margin-bottom: 1rem; /* mb-4 */
        }

        /* Form elements */
        .form-label {
            font-size: 0.875rem; /* sm */
            font-weight: 500;
            color: var(--secondary-text);
            display: block;
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .form-input, .form-select {
            background-color: var(--input-bg);
            color: #F9FAFB;
            border: 1px solid #4A5568; /* Subtle border */
            border-radius: 0.5rem; /* rounded-lg */
            width: 100%;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            margin-bottom: 1rem; /* mb-4 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--border-glow); /* Amber focus glow */
            box-shadow: 0 0 0 2px rgba(246, 173, 5, 0.5); /* Amber focus glow */
        }
        .form-input::placeholder {
            color: #718096; /* Gray-500 */
        }

        /* Primary Button */
        .btn-primary {
            background-color: var(--button-bg);
            color: var(--button-text);
            font-weight: 700;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem; /* Slightly more rounded */
            width: 100%;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            border: none;
            font-size: 1.125rem; /* Larger text */
            box-shadow: 0 4px 10px rgba(246, 173, 5, 0.3); /* Button specific glow */
        }
        .btn-primary:hover {
            background-color: var(--hover-button-bg);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-primary:disabled {
            background-color: #4A5568; /* Gray-600 */
            color: #A0AEC0; /* Gray-400 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Remove Button */
        .btn-remove {
            background-color: var(--remove-button-bg);
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.2rem 0.6rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn-remove:hover {
            background-color: var(--remove-button-hover);
        }

        /* Exercise list item */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #252A36; /* Slightly lighter than card-bg for contrast */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #F9FAFB;
        }
        .exercise-item-details {
            font-size: 0.9rem;
            color: var(--secondary-text);
            margin-left: 0.75rem;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* --- WORKOUT SCREEN STYLES --- */
        #workout-timer {
            font-size: 6rem; /* 96px */
            font-weight: 900;
            color: var(--golden-text);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        #countdown-text {
            font-size: 15rem; /* Absolutely massive */
            font-weight: 900;
            color: var(--golden-text);
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            /* Animation for countdown pulse */
            animation: pulse-and-fade 1s ease-in-out infinite;
        }

        @keyframes pulse-and-fade {
            0% { transform: scale(0.9); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.8; }
        }

        /* --- REP COUNTER STYLES --- */
        #rep-counter-tap-area {
            cursor: pointer;
            user-select: none; /* Prevents text selection on tap */
            padding: 1rem 0;
            background-color: rgba(255,255,255,0.02);
            border-radius: 0.75rem;
            transition: background-color 0.1s;
        }
        #rep-counter-tap-area:active {
            background-color: rgba(255,255,255,0.05);
            transform: scale(0.99);
        }
        
        #current-exercise-name, #emom-exercise-name {
            font-size: 2.25rem; /* 3xl */
            font-weight: 700;
            color: #F9FAFB; /* White, more prominent */
            text-align: center;
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }
        
        #current-rep-count, #emom-rep-info {
            font-size: 6rem; /* 6xl */
            font-weight: 900;
            color: var(--golden-text);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            line-height: 1;
            text-align: center;
            margin-bottom: 1rem;
        }

        #current-round-info, #emom-minute-info {
            font-size: 2rem; /* 2xl */
            font-weight: 500;
            color: var(--secondary-text);
            text-align: center;
            margin-bottom: 2rem; /* More space before button */
        }
        
        /* --- SET TRACKER STYLES (Standard) --- */
        #set-exercise-name {
            font-size: 2.25rem; /* 3xl */
            font-weight: 700;
            color: #F9FAFB; /* White, more prominent */
            text-align: center;
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }
        
        #set-rep-info {
            font-size: 6rem; /* 6xl */
            font-weight: 900;
            color: var(--golden-text);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            line-height: 1;
            text-align: center;
            margin-bottom: 1rem;
        }

        #set-count-info {
            font-size: 2rem; /* 2xl */
            font-weight: 500;
            color: var(--secondary-text);
            text-align: center;
            margin-bottom: 2rem; /* More space before button */
        }

    </style>
</head>
<body class="pt-10">

    <!-- Builder Screen -->
    <div id="builder-screen" class="main-container">
        <div class="app-card">
            
            <h1 class="h1-main">PRE-SEASON</h1>
            <h2 class="h2-sub">CONDITIONING</h2>

            <div class="space-y-5 mt-6">

                <!-- 1. Select Format -->
                <div>
                    <label for="workout-format" class="form-label">1. Select Format</label>
                    <select id="workout-format" class="form-select">
                        <option value="amrap">AMRAP (As Many Rounds As Possible)</option>
                        <option value="emom">EMOM (Every Minute On The Minute)</option>
                        <option value="rft">RFT (Rounds For Time)</option>
                        <option value="chipper">Chipper (For Time)</option>
                        <option value="standard">Standard (Sets x Reps)</option>
                    </select>
                </div>

                <!-- 2. Set Time/Rounds (Dynamic) -->
                <div id="format-options">
                    <!-- Content injected by JS -->
                </div>

                <!-- 3. Add Exercises -->
                <div>
                    <h3 class="section-title mb-3">3. Add Exercises</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="exercise-name" class="form-label">Exercise Name</label>
                            <input type="text" id="exercise-name" class="form-input" placeholder="e.g., Burpees">
                        </div>
                        
                        <div id="exercise-details" class="flex space-x-4">
                            <!-- Content injected by JS -->
                        </div>
                        <button id="add-exercise-btn" class="btn-primary !mt-5">Add Exercise</button>
                    </div>
                </div>
            </div>

            <!-- 4. Workout Summary -->
            <div id="workout-summary" class="mt-8 hidden">
                <h3 class="section-title text-xl mb-4">Your Workout</h3>
                <p id="summary-header" class="text-lg text-[var(--primary-text)] font-semibold mb-4"></p>
                <ul id="summary-list" class="space-y-3">
                    <!-- Content injected by JS -->
                </ul>
                <button id="start-workout-btn" class="btn-primary !mt-6 !bg-green-600 !hover:bg-green-700 !shadow-lg !shadow-green-500/30">
                    Start Workout
                </button>
            </div>

        </div>
    </div>
    
    <!-- Workout Screen -->
    <div id="workout-screen" class="main-container hidden">
        
        <!-- 
          Countdown Overlay
          All styles are Tailwind classes. .hidden class will work.
        -->
        <div id="countdown-overlay" class="hidden fixed inset-0 bg-[rgba(14,18,27,0.95)] flex items-center justify-center z-50">
            <span id="countdown-text">3</span>
        </div>

        <!-- Main Workout Card -->
        <div class="app-card">
            
            <!-- Timer Display -->
            <div class="text-center">
                <div id="workout-timer">00:00</div>
                <div id="workout-type-header" class="text-lg font-bold text-[var(--primary-text)] uppercase tracking-widest -mt-2 mb-4">
                    AMRAP
                </div>
            </div>

            <!-- 
              This container will hold ONE of the three views:
              1. The EMOM tracker (#emom-view)
              2. The Rep Counter (#rep-counter-view)
              3. The Set Tracker (#set-tracker-view)
            -->
            <div id="workout-view-container">

                <!-- View 1: EMOM Tracker (NEW) -->
                <div id="emom-view" class="hidden pt-4 text-center">
                    <div id="emom-exercise-name" class="text-3xl font-bold text-white mb-2">Push Ups</div>
                    <div id="emom-rep-info" class="text-6xl font-extrabold text-[var(--golden-text)] mb-4">15 Reps</div>
                    <div id="emom-minute-info" class="text-2xl font-semibold text-[var(--secondary-text)] mb-8">Minute 1 / 10</div>
                    <button id="emom-set-done-btn" class="btn-primary !w-full !py-4 !text-xl !font-bold">Set Done</button>
                </div>
                
                <!-- View 2: AMRAP/RFT/Chipper Rep Counter -->
                <div id="rep-counter-view" class="hidden pt-4">
                    <!-- This div is now the tap target -->
                    <div id="rep-counter-tap-area"> 
                        <div id="current-exercise-name">Burpees</div>
                        <div id="current-rep-count">10</div>
                        <div id="current-round-info">Round 1</div>
                    </div>
                    <!-- New "Set Done" button for this view -->
                    <button id="set-done-rep-btn" class="btn-primary !w-full !py-3 !text-lg !font-bold !mt-6 !bg-blue-600 !hover:bg-blue-700 !shadow-lg !shadow-blue-500/30">
                        Set Done
                    </button>
                </div>
                
                <!-- View 3: Standard Set Tracker -->
                <div id="set-tracker-view" class="hidden pt-4 text-center">
                    <div id="set-exercise-name" class="text-3xl font-bold text-white mb-2">Bench Press</div>
                    <div id="set-rep-info" class="text-6xl font-extrabold text-[var(--golden-text)] mb-4">10 Reps</div>
                    <div id="set-count-info" class="text-2xl font-semibold text-[var(--secondary-text)] mb-8">Set 1 / 3</div>
                    <button id="set-done-btn" class="btn-primary !w-full !py-4 !text-xl !font-bold">Set Done</button>
                </div>

            </div>
            
            <!-- Controls -->
            <div class="flex space-x-4 mt-6">
                <button id="pause-resume-btn" class="btn-primary !w-1/2">Pause</button>
                <button id="end-workout-btn" class="btn-primary !w-1/2 !bg-red-600 !hover:bg-red-700 !shadow-lg !shadow-red-500/30">End</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- STATE ---
            let workoutConfig = {
                format: 'amrap',
                time: null, // in minutes
                rounds: null,
                exercises: [] // { name, reps, sets? }
            };

            let timerInterval = null;
            let totalSeconds = 0;
            let isPaused = false;
            
            // Tracking state for rep counter (AMRAP, RFT, Chipper)
            let currentExerciseIndex = 0;
            let currentRepCount = 0;
            let currentRound = 1;
            
            // State for Standard workouts
            let standardExIndex = 0;
            let standardSetNum = 1;
            
            // State for EMOM workouts
            let emomCurrentMinute = 0; // The current minute (0-indexed)
            let emomSetDoneForMinute = false;


            // --- DOM ELEMENTS ---
            const builderScreen = document.getElementById('builder-screen');
            const workoutScreen = document.getElementById('workout-screen');
            
            // Builder UI
            const formatSelect = document.getElementById('workout-format');
            const formatOptionsContainer = document.getElementById('format-options');
            const exerciseDetailsContainer = document.getElementById('exercise-details');
            const exerciseNameInput = document.getElementById('exercise-name');
            const addExerciseBtn = document.getElementById('add-exercise-btn');
            const summaryContainer = document.getElementById('workout-summary');
            const summaryHeader = document.getElementById('summary-header');
            const summaryList = document.getElementById('summary-list');
            const startWorkoutBtn = document.getElementById('start-workout-btn');

            // Workout UI
            const countdownOverlay = document.getElementById('countdown-overlay');
            const countdownText = document.getElementById('countdown-text');
            const timerDisplay = document.getElementById('workout-timer');
            const typeHeader = document.getElementById('workout-type-header');
            const pauseResumeBtn = document.getElementById('pause-resume-btn');
            const endWorkoutBtn = document.getElementById('end-workout-btn');

            // Workout Views
            const repCounterView = document.getElementById('rep-counter-view');
            const repCounterTapArea = document.getElementById('rep-counter-tap-area'); // Tap target
            const currentExerciseName = document.getElementById('current-exercise-name');
            const currentRepCountEl = document.getElementById('current-rep-count');
            const currentRoundInfo = document.getElementById('current-round-info');
            const setDoneRepBtn = document.getElementById('set-done-rep-btn'); // "Set Done" for AMRAPs
            
            const setTrackerView = document.getElementById('set-tracker-view');
            const setExerciseName = document.getElementById('set-exercise-name');
            const setRepInfo = document.getElementById('set-rep-info');
            const setCountInfo = document.getElementById('set-count-info');
            const setDoneBtn = document.getElementById('set-done-btn'); // "Set Done" for Standard

            const emomView = document.getElementById('emom-view');
A            const emomExerciseName = document.getElementById('emom-exercise-name');
            const emomRepInfo = document.getElementById('emom-rep-info');
            const emomMinuteInfo = document.getElementById('emom-minute-info');
            const emomSetDoneBtn = document.getElementById('emom-set-done-btn');


            // --- FUNCTIONS ---

            /**
             * Updates the UI inputs based on the selected workout format.
             */
            function updateFormatOptions() {
                const format = formatSelect.value;
                workoutConfig.format = format;
                
                formatOptionsContainer.innerHTML = '';
                exerciseDetailsContainer.innerHTML = '';

                let formatOptionsHTML = '';
                let exerciseDetailsHTML = '';

                switch (format) {
                    case 'amrap':
                        formatOptionsHTML = `
                            <div>
                                <label for="workout-time" class="form-label">2. Set Time</label>
                                <input type="number" id="workout-time" class="form-input" placeholder="Time (minutes)">
                            </div>
                        `;
                        exerciseDetailsHTML = `
                            <div class="flex-1">
                                <label for="exercise-reps" class="form-label">Reps</label>
                                <input type="number" id="exercise-reps" class="form-input" placeholder="e.g., 10">
                            </div>
                        `;
                        break;
                    
                    case 'emom':
                        formatOptionsHTML = `
                            <div>
                                <label for="workout-time" class="form-label">2. Set Time</label>
                                <input type="number" id="workout-time" class="form-input" placeholder="Total Minutes">
                            </div>
                        `;
                         exerciseDetailsHTML = `
                            <div class="flex-1">
                                <label for="exercise-reps" class="form-label">Reps</label>
                                <input type="number" id="exercise-reps" class="form-input" placeholder="e.g., 10">
                            </div>
                        `;
                        break;

                    case 'rft':
                        formatOptionsHTML = `
                            <div>
                                <label for="workout-rounds" class="form-label">2. Set Rounds</label>
                                <input type="number" id="workout-rounds" class="form-input" placeholder="e.g., 5">
                            </div>
                        `;
                         exerciseDetailsHTML = `
                            <div class="flex-1">
                                <label for="exercise-reps" class="form-label">Reps</label>
                                <input type="number" id="exercise-reps" class="form-input" placeholder="e.g., 10">
                            </div>
                        `;
                        break;

                    case 'chipper':
                        formatOptionsHTML = `<p class="form-label text-center mb-0">2. Add exercises in order</p>`;
                         exerciseDetailsHTML = `
                            <div class="flex-1">
                                <label for="exercise-reps" class="form-label">Reps</label>
                                <input type="number" id="exercise-reps" class="form-input" placeholder="e.g., 10">
                            </div>
                        `;
                        break;
                        
                    case 'standard':
                        formatOptionsHTML = `<p class="form-label text-center mb-0">2. Add exercises with sets & reps</p>`;
                        // Now ask for SETS and REPS
                        exerciseDetailsHTML = `
                            <div class="flex-1">
                                <label for="exercise-sets" class="form-label">Sets</label>
                                <input type="number" id="exercise-sets" class="form-input" placeholder="e.g., 3">
                            </div>
                            <div class="flex-1">
                                <label for="exercise-reps" class="form-label">Reps</label>
                                <input type="text" id="exercise-reps" class="form-input" placeholder="e.g., 8-10">
                            </div>
                        `;
                        break;
                }

                formatOptionsContainer.innerHTML = formatOptionsHTML;
                exerciseDetailsContainer.innerHTML = exerciseDetailsHTML;
                addFormatInputListeners();
            }

            /**
             * Adds event listeners to the dynamically created format inputs.
             */
            function addFormatInputListeners() {
                const timeInput = document.getElementById('workout-time');
                const roundsInput = document.getElementById('workout-rounds');

                if (timeInput) {
                    timeInput.addEventListener('input', (e) => {
                        workoutConfig.time = e.target.value ? parseInt(e.target.value, 10) : null;
                        renderWorkoutSummary();
                    });
                }
                if (roundsInput) {
                    roundsInput.addEventListener('input', (e) => {
                        workoutConfig.rounds = e.target.value ? parseInt(e.target.value, 10) : null;
                        renderWorkoutSummary();
                    });
                }
            }

            /**
             * Adds a new exercise to the config object from the inputs.
             */
            function addExercise() {
                const name = exerciseNameInput.value.trim();
                const repsInput = document.getElementById('exercise-reps');
                const setsInput = document.getElementById('exercise-sets'); // Get the new sets input
                
                const reps = repsInput ? repsInput.value.trim() : null;
                const sets = setsInput ? setsInput.value.trim() : null;

                if (!name) {
                    showCustomMessage('Please enter an exercise name.');
                    return;
                }

                // Validation based on format
                if (workoutConfig.format === 'standard') {
                    if (!sets || !reps) {
                        showCustomMessage('Please enter sets and reps for this exercise.');
                        return;
                    }
                    // For 'standard', reps can be a string like "8-10"
                    workoutConfig.exercises.push({ name, sets: parseInt(sets, 10), reps });
                } else {
                    if (!reps) {
                        showCustomMessage('Please enter reps for this exercise.');
                        return;
                    }
                    // For all other formats, reps are a number
                    workoutConfig.exercises.push({ name, reps: parseInt(reps, 10), sets: null });
                }
                
                exerciseNameInput.value = '';
                if (repsInput) repsInput.value = '';
                if (setsInput) setsInput.value = ''; // Clear sets input
                exerciseNameInput.focus();
                
                renderWorkoutSummary();
            }

            /**
             * Renders the entire workout summary based on the config object.
             */
            function renderWorkoutSummary() {
                const { format, time, rounds, exercises } = workoutConfig;
                
                if (exercises.length === 0) {
                    summaryContainer.classList.add('hidden');
                    return;
                }
                
                summaryContainer.classList.remove('hidden');

                // 1. Update Header
                let headerText = '';
                switch (format) {
                    case 'amrap':
                        headerText = time ? `${time} MINUTE AMRAP` : 'AMRAP';
                        break;
                    case 'emom':
                        headerText = time ? `${time} MINUTE EMOM` : 'EMOM';
                        break;
                    case 'rft':
                        headerText = rounds ? `${rounds} ROUNDS FOR TIME` : 'ROUNDS FOR TIME';
                        break;
                    case 'chipper':
                        headerText = 'CHIPPER (FOR TIME)';
                        break;
                    case 'standard':
                        headerText = 'STANDARD WORKOUT (FOR TIME)';
                        break;
                }
                summaryHeader.textContent = headerText;

                // 2. Update Exercise List
                summaryList.innerHTML = '';
                exercises.forEach((ex, index) => {
                    let details = '';
                    if (ex.sets && ex.reps) { // Standard format
                        details = `${ex.sets} sets x ${ex.reps} reps`;
                    } else if (ex.reps) { // AMRAP, RFT, EMOM, Chipper
                        details = `${ex.reps} reps`;
                    }
                    
                    const li = document.createElement('li');
                    li.className = "exercise-item";
                    li.innerHTML = `
                        <span class="text-white font-medium">
                            ${ex.name}
                            ${details ? `<span class="exercise-item-details">(${details})</span>` : ''}
                        </span>
                        <button class="btn-remove" data-index="${index}">Remove</button>
                    `;
                    summaryList.appendChild(li);
                });
            }

            /**
             * Handles clicks on the summary list (for remove buttons).
             */
            function handleSummaryClick(e) {
                if (e.target.classList.contains('btn-remove')) {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    workoutConfig.exercises.splice(indexToRemove, 1);
                    renderWorkoutSummary();
                }
            }

            /**
             * Shows a simple custom message overlay.
             */
            function showCustomMessage(message) {
                // Check if a message box already exists
                if (document.getElementById('custom-message-box')) return;

                const messageBox = document.createElement('div');
                messageBox.id = 'custom-message-box';
                messageBox.style = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100;";
                
                const messageCard = document.createElement('div');
                messageCard.style = "background: var(--card-bg); padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5);";
                messageCard.innerHTML = `<p class="text-white mb-4">${message}</p>`;
                
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = 'btn-primary !w-auto !px-8';
                okButton.onclick = () => messageBox.remove();
                
                messageCard.appendChild(okButton);
                messageBox.appendChild(messageCard);
                document.body.appendChild(messageBox);
                
                okButton.focus();
            }
            
            // --- WORKOUT LOGIC ---

            /**
             * Hides builder, shows timer, starts 3-sec countdown.
             */
            function prepareWorkout() {
                // Validate workout
                if (workoutConfig.exercises.length === 0) {
                    showCustomMessage("Please add at least one exercise.");
                    return;
                }
                if ((workoutConfig.format === 'amrap' || workoutConfig.format === 'emom') && !workoutConfig.time) {
                    showCustomMessage("Please set the time for this workout.");
                    return;
                }
                if (workoutConfig.format === 'rft' && !workoutConfig.rounds) {
                    showCustomMessage("Please set the rounds for this workout.");
                    return;
                }

                // Setup the workout screen
                builderScreen.classList.add('hidden');
                workoutScreen.classList.remove('hidden');
                
                typeHeader.textContent = summaryHeader.textContent;
                
                // --- STATE RESET (FIX) ---
                isPaused = false;
                pauseResumeBtn.textContent = 'Pause';
                pauseResumeBtn.disabled = false;
                
                // Reset tracker states
                currentExerciseIndex = 0;
                currentRound = 1;
                standardExIndex = 0;
                standardSetNum = 1;
                emomCurrentMinute = 0;
                emomSetDoneForMinute = false;

                // --- SMART VIEW SELECTION ---
                if (workoutConfig.format === 'emom') {
                    // Show EMOM List View
                    emomView.classList.remove('hidden');
                    repCounterView.classList.add('hidden');
                    setTrackerView.classList.add('hidden');
                    setupEmomView();
                } else if (workoutConfig.format === 'standard') {
                    // Show Standard Set Tracker View
                    emomView.classList.add('hidden');
                    repCounterView.classList.add('hidden');
                    setTrackerView.classList.remove('hidden');
                    setupSetTrackerView();
                } else {
                    // Show Rep Counter View (AMRAP, RFT, Chipper)
                    emomView.classList.add('hidden');
                    repCounterView.classList.remove('hidden');
                    setTrackerView.classList.add('hidden');
                    setupRepCounterView();
                }

                // Start the 3-second countdown
                startCountdown();
            }

            /**
             * Runs the 3-2-1-GO countdown.
             */
            function startCountdown() {
                countdownOverlay.classList.remove('hidden');
                let countdownVal = 3;
                countdownText.innerText = countdownVal;
                
                const countdownInterval = setInterval(() => {
                    countdownVal--;
                    if (countdownVal > 0) {
                        countdownText.innerText = countdownVal;
                    } else if (countdownVal === 0) {
                        countdownText.innerText = 'GO!';
                    } else if (countdownVal < 0) {
                        clearInterval(countdownInterval);
                        countdownOverlay.classList.add('hidden'); // This will now work!
                        startWorkoutTimer();
                    }
                }, 1000);
            }

            /**
             * Starts the main workout timer (count up or down).
             */
            function startWorkoutTimer() {
                const format = workoutConfig.format;
                
                // AMRAP and EMOM count down
                if (format === 'amrap' || format === 'emom') {
                    totalSeconds = workoutConfig.time * 60;
                    timerInterval = setInterval(tickDown, 1000);
                } else {
                    // RFT, Chipper, and Standard count up
                    totalSeconds = 0;
                    timerInterval = setInterval(tickUp, 1000);
                }
                updateTimerDisplay();
            }

            function tickDown() {
                if (isPaused) return;
                
                totalSeconds--;
                updateTimerDisplay();

                if (workoutConfig.format === 'emom') {
                    updateEmomView(); // Check for minute change
                }

                if (totalSeconds <= 0) {
                    clearInterval(timerInterval);
                    finishTimedWorkout(); // Handle end for AMRAP/EMOM
                }
            }

            function tickUp() {
                if (isPaused) return;
                
                totalSeconds++;
                updateTimerDisplay();
            }

            function updateTimerDisplay() {
                const minutes = Math.floor(Math.abs(totalSeconds) / 60);
                const seconds = Math.abs(totalSeconds) % 60;
                timerDisplay.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function togglePause() {
                isPaused = !isPaused;
                pauseResumeBtn.textContent = isPaused ? 'Resume' : 'Pause';
            }

            function endWorkout() {
                clearInterval(timerInterval);
                workoutScreen.classList.add('hidden');
                builderScreen.classList.remove('hidden');
                // Reset summary
                workoutConfig.exercises = [];
                // Reset config values
                workoutConfig.time = null;
                workoutConfig.rounds = null;
                // Clear inputs
                const timeInput = document.getElementById('workout-time');
                const roundsInput = document.getElementById('workout-rounds');
                if (timeInput) timeInput.value = '';
                if (roundsInput) roundsInput.value = '';
                
                renderWorkoutSummary();
                
                // Reset dynamic "DONE" views
                resetTrackerViews();
            }
            
            function resetTrackerViews() {
                // Reset Standard View
                setTrackerView.innerHTML = `
                    <div id="set-exercise-name" class="text-3xl font-bold text-white mb-2">Bench Press</div>
                    <div id="set-rep-info" class="text-6xl font-extrabold text-[var(--golden-text)] mb-4">10 Reps</div>
                    <div id="set-count-info" class="text-2xl font-semibold text-[var(--secondary-text)] mb-8">Set 1 / 3</div>
                    <button id="set-done-btn" class="btn-primary !w-full !py-4 !text-xl !font-bold">Set Done</button>
                `;
                
                // Reset Rep Counter View
                repCounterView.innerHTML = `
                    <div id="rep-counter-tap-area"> 
                        <div id="current-exercise-name">Burpees</div>
                        <div id="current-rep-count">10</div>
                        <div id="current-round-info">Round 1</div>
                    </div>
                    <button id="set-done-rep-btn" class="btn-primary !w-full !py-3 !text-lg !font-bold !mt-6 !bg-blue-600 !hover:bg-blue-700 !shadow-lg !shadow-blue-500/30">
                        Set Done
                    </button>
                `;
                
                // Reset EMOM View
                emomView.innerHTML = `
                    <div id="emom-exercise-name" class="text-3xl font-bold text-white mb-2">Push Ups</div>
                    <div id="emom-rep-info" class="text-6xl font-extrabold text-[var(--golden-text)] mb-4">15 Reps</div>
                    <div id="emom-minute-info" class="text-2xl font-semibold text-[var(--secondary-text)] mb-8">Minute 1 / 10</div>
                    <button id="emom-set-done-btn" class="btn-primary !w-full !py-4 !text-xl !font-bold">Set Done</button>
                `;

                // Re-add event listeners since innerHTML removes them
                document.getElementById('set-done-btn').addEventListener('click', handleSetDoneClick);
                document.getElementById('rep-counter-tap-area').addEventListener('click', handleRepTap);
                document.getElementById('set-done-rep-btn').addEventListener('click', handleSetDoneRepClick);
                document.getElementById('emom-set-done-btn').addEventListener('click', handleEmomSetDoneClick);
            }
            
            // --- SMART VIEW: EMOM (NEW) ---
            
            function setupEmomView() {
                emomCurrentMinute = 0;
                emomSetDoneForMinute = false;
                emomSetDoneBtn.disabled = false;
                
                loadEmomMinute();
            }
            
            function loadEmomMinute() {
                const totalMinutes = workoutConfig.time;
                const totalExercises = workoutConfig.exercises.length;
                
                // Find current exercise based on minute, cycling through
                const exerciseIndex = emomCurrentMinute % totalExercises;
                const exercise = workoutConfig.exercises[exerciseIndex];
                
                // Update UI
                emomExerciseName.textContent = exercise.name;
                emomRepInfo.textContent = `${exercise.reps} Reps`;
                emomMinuteInfo.textContent = `Minute ${emomCurrentMinute + 1} / ${totalMinutes}`;
                
                // Re-enable button for the new minute
                emomSetDoneForMinute = false;
                emomSetDoneBtn.disabled = false;
                emomSetDoneBtn.textContent = 'Set Done';
            }
            
            function updateEmomView() {
                // This function is called every second by tickDown
                const secondsRemainingInMinute = totalSeconds % 60;
                
                if (secondsRemainingInMinute === 0) {
                    // It's the start of a new minute
                    emomCurrentMinute++;
                    
                    if (emomCurrentMinute < workoutConfig.time) {
                        loadEmomMinute();
                    }
                    // else: the timer will stop itself at 0
                }
            }
            
            function handleEmomSetDoneClick() {
                if (isPaused) return;
                
                emomSetDoneForMinute = true;
                emomSetDoneBtn.disabled = true;
                emomSetDoneBtn.textContent = 'Done for this minute';
            }

            function finishTimedWorkout() {
                // For AMRAP or EMOM
                timerDisplay.innerText = "DONE!";
                pauseResumeBtn.disabled = true;

                if (workoutConfig.format === 'emom') {
                    emomView.innerHTML = `
                        <div id="emom-exercise-name" class="text-3xl font-bold text-white mb-2">Workout</div>
                        <div id="emom-rep-info" class="text-6xl font-extrabold text-[var(--golden-text)] mb-4">DONE!</div>
                        <div id="emom-minute-info" class="text-2xl font-semibold text-[var(--secondary-text)] mb-8">
                            Completed ${workoutConfig.time} minutes.
                        </div>
                    `;
                }
                
                if (workoutConfig.format === 'amrap') {
                    // Show final round count
                    currentExerciseName.textContent = "Workout";
                    currentRepCountEl.textContent = "DONE!";
                    currentRoundInfo.textContent = `Completed ${currentRound - 1} rounds.`;
                    setDoneRepBtn.classList.add('hidden'); // Hide button
                }
            }
            
            // --- SMART VIEW: REP COUNTER (AMRAP, RFT, Chipper) ---
            
            function setupRepCounterView() {
                currentExerciseIndex = 0;
                currentRound = 1;
                // Make sure "Set Done" button is visible
                setDoneRepBtn.classList.remove('hidden');
                loadExerciseIntoRepCounter();
            }
            
            function loadExerciseIntoRepCounter() {
                if (currentExerciseIndex >= workoutConfig.exercises.length) {
                    // --- Handle end of a round ---
                    if (workoutConfig.format === 'amrap') {
                        currentExerciseIndex = 0; // Loop back to start
                        currentRound++;
                    } else if (workoutConfig.format === 'rft') {
                        if (currentRound >= workoutConfig.rounds) {
                            // --- RFT WORKOUT COMPLETE ---
                            finishRftChipperWorkout();
                            return;
                        } else {
                            currentExerciseIndex = 0; // Loop back to start
                            currentRound++;
                        }
                    } else if (workoutConfig.format === 'chipper') {
                         // --- CHIPPER WORKOUT COMPLETE ---
                        finishRftChipperWorkout();
                        return;
                    }
                }

                // Load the exercise
                const exercise = workoutConfig.exercises[currentExerciseIndex];
                currentRepCount = exercise.reps;
                
                // Update UI
                currentExerciseName.textContent = exercise.name;
                currentRepCountEl.textContent = currentRepCount;
                updateRoundInfo();
            }
            
            function handleRepTap() {
                if (isPaused || currentRepCount <= 0) return;
                
                currentRepCount--;
                currentRepCountEl.textContent = currentRepCount;
                
                if (currentRepCount === 0) {
                    // Play a sound, haptic feedback, etc.
                    currentExerciseIndex++;
                    // Short delay then load next
                    setTimeout(loadExerciseIntoRepCounter, 300); 
                }
            }
            
            /**
             * "Set Done" button in rep counter view.
             * Skips all reps and moves to the next exercise.
             */
            function handleSetDoneRepClick() {
                if (isPaused || currentRepCount <= 0) return;

                currentRepCount = 0;
                currentRepCountEl.textContent = 0;
                
                currentExerciseIndex++;
                setTimeout(loadExerciseIntoRepCounter, 300);
            }
            
            function updateRoundInfo() {
                const format = workoutConfig.format;
                if (format === 'amrap') {
                    currentRoundInfo.textContent = `Round ${currentRound}`;
                } else if (format === 'rft') {
                    currentRoundInfo.textContent = `Round ${currentRound} / ${workoutConfig.rounds}`;
                } else if (format === 'chipper') {
                    currentRoundInfo.textContent = `Exercise ${currentExerciseIndex + 1} / ${workoutConfig.exercises.length}`;
                }
            }
            
            function finishRftChipperWorkout() {
                clearInterval(timerInterval); // Stop the timer
                isPaused = true;
                currentExerciseName.textContent = "Workout";
                currentRepCountEl.textContent = "DONE!";
                currentRoundInfo.textContent = `Final Time: ${timerDisplay.textContent}`;
                pauseResumeBtn.disabled = true;
                // Hide the "Set Done" button on completion
                setDoneRepBtn.classList.add('hidden');
            }
            
            // --- SMART VIEW: SET TRACKER (STANDARD) ---

            function setupSetTrackerView() {
                if (standardExIndex >= workoutConfig.exercises.length) {
                    // --- STANDARD WORKOUT COMPLETE ---
                    finishStandardWorkout();
                    return;
                }

                // Load the exercise
                const exercise = workoutConfig.exercises[standardExIndex];
                
                // Update UI
                setExerciseName.textContent = exercise.name;
                setRepInfo.textContent = `${exercise.reps} Reps`;
                setCountInfo.textContent = `Set ${standardSetNum} / ${exercise.sets}`;
                setDoneBtn.disabled = false; // Re-enable button
            }

            function handleSetDoneClick() {
                if (isPaused) return;

                const exercise = workoutConfig.exercises[standardExIndex];

                if (standardSetNum < exercise.sets) {
                    // More sets for this exercise
                    standardSetNum++;
                } else {
                    // This exercise is done, move to next
                    standardExIndex++;
                    standardSetNum = 1; // Reset set number for next exercise
                }
                
                // Load the next state into the UI (will show "DONE" if finished)
                setupSetTrackerView();
            }
            
            function finishStandardWorkout() {
                clearInterval(timerInterval); // Stop the timer
                isPaused = true;
                // Hide the button and show "DONE"
                setTrackerView.innerHTML = `
                    <div id="set-exercise-name" class="text-3xl font-bold text-white mb-2">Workout</div>
                    <div id="set-rep-info" class="text-6xl font-extrabold text-[var(--golden-text)] mb-4">DONE!</div>
                    <div id="set-count-info" class="text-2xl font-semibold text-[var(--secondary-text)] mb-8">
                        Final Time: ${timerDisplay.textContent}
                    </div>
                `;
                pauseResumeBtn.disabled = true;
            }


            // --- INITIALIZATION ---
            formatSelect.addEventListener('change', () => {
                updateFormatOptions();
                renderWorkoutSummary();
            });
            addExerciseBtn.addEventListener('click', addExercise);
            summaryList.addEventListener('click', handleSummaryClick);

            startWorkoutBtn.addEventListener('click', prepareWorkout);
            
            // Workout screen listeners
            pauseResumeBtn.addEventListener('click', togglePause);
            endWorkoutBtn.addEventListener('click', endWorkout);
            
            // Listeners for different tracker types
            repCounterTapArea.addEventListener('click', handleRepTap);
            setDoneRepBtn.addEventListener('click', handleSetDoneRepClick);
            setDoneBtn.addEventListener('click', handleSetDoneClick);
            emomSetDoneBtn.addEventListener('click', handleEmomSetDoneClick);

            // Initial setup
            updateFormatOptions();
        });
    </script>
</body>
</html>

