<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Workout Builder</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        
        html, body {
            /* height: 100%; */
            /* overflow: hidden; */ /* Prevent scrolling */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0E121B; /* Very dark background */
            color: #F9FAFB; /* Light text */
            /* Removed flex properties */
        }

        /* Custom color variables matching the provided image */
        :root {
            --bg-dark: #0E121B;
            --card-bg: #1A1F2B; /* Darker card background */
            --border-glow: #F6AD05; /* Amber glow from the image */
            --primary-text: #F6AD05; /* Amber text for titles/accents */
            --secondary-text: #A0AEC0; /* Grayish text */
            --input-bg: #2D3748; /* Darker input background */
            --button-bg: #F6AD05; /* Amber button */
            --button-text: #0E121B; /* Dark text on amber button */
            --hover-button-bg: #D97706; /* Darker amber for hover */
            --remove-button-bg: #EF4444; /* Red for remove */
            --remove-button-hover: #DC2626; /* Darker red for remove hover */

            /* New golden glow for title */
            --golden-text: #FFD700; /* Gold color */
            --golden-glow-light: #FFEA00; /* Lighter gold for inner glow */
            --golden-glow-strong: #FFA500; /* Orange-gold for outer glow */
            
            --error-border: #EF4444; /* Red for validation */
            --default-border: #4A5568; /* Default input border */
        }
        
        /* Main container for builder and workout screens */
        .main-container {
            width: 100%;
            /* height: 100%; */
            max-width: 500px; /* Constrain width */
            margin: auto;
            /* overflow-y: auto; */ /* Allow scrolling within the card */
            padding: 2rem 1rem; /* Give it some vertical padding */
            /* display: flex; */
            /* align-items: center; */ /* Center the card vertically */
        }

        /* Main app container styling with glow */
        .app-card {
            background-color: var(--card-bg);
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2rem;
            width: 100%;
            /* Toned down overall card glow, using amber */
            box-shadow: 0 0 20px rgba(246, 173, 5, 0.4); 
            border: 1px solid rgba(246, 173, 5, 0.3); /* Subtle amber border for definition */
        }

        /* Titles */
        .h1-main {
            font-weight: 900; /* Extra bold */
            color: var(--golden-text); /* Golden color */
            text-align: center;
            font-size: 3.5rem; /* Even larger */
            margin-bottom: 0.5rem;
            letter-spacing: -0.07em; /* Tighter letter spacing */
            /* Toned down text shadow for golden glow */
            text-shadow: 
                0 0 8px rgba(255, 215, 0, 0.5), /* Softer inner glow */
                0 0 15px rgba(246, 173, 5, 0.4); /* Fainter outer amber glow */
        }
        .h2-sub {
            font-weight: 700; /* Bold */
            color: var(--golden-text); /* Also golden for consistency */
            text-align: center;
            font-size: 1.8rem; /* Larger */
            margin-bottom: 2rem;
            text-shadow: 0 0 6px rgba(255, 215, 0, 0.3); /* Toned down subtle glow for sub-title */
        }
        .section-title {
            font-weight: 700;
            color: #F9FAFB;
            font-size: 1.125rem; /* lg */
            margin-bottom: 1rem;
        }

        /* Form elements */
        .form-label {
            font-size: 0.875rem; /* sm */
            font-weight: 500;
            color: var(--secondary-text);
            display: block;
            margin-bottom: 0.5rem; /* Increased spacing */
        }
        .form-input, .form-select {
            background-color: var(--input-bg);
            color: #F9FAFB;
            border: 1px solid var(--default-border); /* Subtle border */
            border-radius: 0.5rem;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1.25rem; /* More spacing between elements */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--border-glow); /* Back to amber focus glow */
            box-shadow: 0 0 0 2px rgba(246, 173, 5, 0.5); /* Amber focus glow */
        }
        .form-input::placeholder {
            color: #A0AEC0; /* Lighter placeholder text */
        }
        
        .form-input.invalid {
            border-color: var(--error-border);
        }

        /* Primary Button */
        .btn {
            font-weight: 700;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem; /* Slightly more rounded */
            width: 100%;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            border: none;
            font-size: 1.125rem; /* Larger text */
            box-shadow: 0 4px 10px rgba(0,0,0, 0.2);
        }
        .btn-primary {
            background-color: var(--button-bg);
            color: var(--button-text);
            box-shadow: 0 4px 10px rgba(246, 173, 5, 0.3); /* Button specific glow */
        }
        .btn-primary:hover {
            background-color: var(--hover-button-bg);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Red 'End' Button */
        .btn-danger {
            background-color: var(--remove-button-bg);
            color: white;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            background-color: var(--remove-button-hover);
            transform: translateY(-1px);
        }
        .btn-danger:active {
            transform: translateY(0);
        }


        /* Remove Button */
        .btn-remove {
            background-color: var(--remove-button-bg);
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.2rem 0.6rem;
            border-radius: 0.5rem; /* Slightly less rounded than original, more consistent with app */
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn-remove:hover {
            background-color: var(--remove-button-hover);
        }

        /* Exercise list item */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #252A36; /* Slightly lighter than card-bg for contrast */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #F9FAFB;
        }
        .exercise-item-details {
            font-size: 0.9rem;
            color: var(--secondary-text);
            margin-left: 0.75rem;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* --- WORKOUT SCREEN STYLES --- */
        #workout-screen {
            /* This is now controlled by .main-container */
        }
        
        #main-timer { /* Renamed from #workout-timer */
            font-size: 7rem; /* Huge timer */
            font-weight: 900;
            color: var(--golden-text);
            text-align: center;
            margin: 1rem 0; /* Reduced margin */
            line-height: 1;
            text-shadow: 
                0 0 8px rgba(255, 215, 0, 0.5),
                0 0 15px rgba(246, 173, 5, 0.4);
        }
        
        /* Renamed from #workout-status */
        #secondary-info-container { 
            text-align: center;
            margin-bottom: 1.5rem; /* Reduced margin */
        }
        
        #secondary-info-label {
            font-size: 1.25rem; /* xl */
            font-weight: 700;
            color: var(--secondary-text);
        }
        #secondary-info-value {
             font-size: 2.25rem; /* 4xl */
             font-weight: 700;
             color: white;
             display: block;
        }
        
        #workout-exercise-list {
            flex-grow: 1; /* Takes up remaining space */
            overflow-y: auto; /* Scroll if list is long */
            space-y: 0.75rem; /* space-y-3 */
            padding: 0 0.5rem;
            margin-bottom: 1.5rem; /* Reduced margin */
            min-height: 100px; /* Ensure it has some height */
        }
        
        #workout-exercise-list .exercise-item.active {
             background-color: var(--border-glow); /* Highlight current exercise */
             color: var(--button-text);
             font-weight: 700;
        }
        #workout-exercise-list .exercise-item.active .exercise-item-details {
             color: var(--card-bg);
        }

        /* --- COUNTDOWN OVERLAY --- */
        #countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(14, 18, 27, 0.95); /* Fullscreen dark bg */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        #countdown-text {
            font-size: 15rem; /* Absolutely massive */
            font-weight: 900;
            color: var(--golden-text);
            text-shadow: 
                0 0 15px rgba(255, 215, 0, 0.5),
                0 0 30px rgba(246, 173, 5, 0.4);
            animation: pulse-and-fade 1s ease-in-out infinite;
        }
        
        @keyframes pulse-and-fade {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.8; }
        }

    </style>
</head>
<body>

    <!-- This div wraps the entire builder UI --><div id="builder-screen" class="main-container">
        
        <!-- Main App Card with Glow --><div class="app-card">
            
            <!-- Header --><h1 class="h1-main">PRE-SEASON</h1>
            <h2 class="h2-sub">CONDITIONING</h2>

            <!-- Main Configuration Form --><div class="space-y-6 mt-8">

                <!-- Step 1: Workout Format --><div>
                    <label for="workout-format" class="form-label">1. Select Format</label>
                    <select id="workout-format" class="form-select">
                        <option value="amrap">AMRAP (As Many Rounds As Possible)</option>
                        <option value="emom">EMOM (Every Minute On The Minute)</option>
                        <option value="rft">RFT (Rounds For Time)</option>
                        <option value="chipper">Chipper (For Time)</option>
                    </select>
                </div>

                <!-- Step 2: Format-Specific Options --><div id="format-options">
                    <!-- This content is generated by JavaScript --></div>

                <!-- Step 3: Exercise Builder --><div>
                    <h3 class="section-title mb-4">3. Add Exercises</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="exercise-name" class="form-label">Exercise Name</label>
                            <input type="text" id="exercise-name" class="form-input" placeholder="e.g., Push Ups">
                        </div>
                        <!-- Exercise-specific details (Reps, Sets) --><div id="exercise-details" class="flex space-x-4">
                            <!-- This content is generated by JavaScript --></div>
                        <button id="add-exercise-btn" class="btn btn-primary !mt-5">Add Exercise</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Workout Summary --><div id="workout-summary" class="mt-8 hidden">
                <h3 class="section-title text-2xl mb-4">Your Workout</h3>
                <p id="summary-header" class="text-xl text-primary-text font-semibold mb-4"></p>
                <ul id="summary-list" class="space-y-3">
                    <!-- This content is generated by JavaScript --></ul>
                <button id="start-workout-btn" class="btn btn-primary !mt-8">Start Workout</button>
            </div>

        </div>

    </div>

    <!-- 
      NEW: Workout Timer Screen (hidden by default)
    -->
    <div id="workout-screen" class="main-container hidden">
        
        <!-- Countdown Overlay -->
        <div id="countdown-overlay" class="hidden">
            <span id="countdown-text">3</span>
        </div>

        <!-- Main Workout Card -->
        <div class="app-card" id="workout-screen-content"> <!-- Added ID -->
            <!-- Workout Title -->
            <h2 id="workout-title" class="h2-sub !text-2xl text-center mb-4">10 MINUTE AMRAP</h2> <!-- Reduced margin -->

            <!-- Main Timer Display -->
            <div id="main-timer" class="text-8xl font-black text-center text-white mb-4">
                10:00
            </div>
            
            <!-- Secondary Info (Rounds/Minutes) -->
            <div id="secondary-info-container" class="text-center mb-4"> <!-- Added container -->
                <span id="secondary-info-label" class="text-xl text-secondary-text">CURRENT ROUND</span>
                <span id="secondary-info-value" class="text-3xl font-bold text-white block">1</span>
            </div>

            <!-- Exercise List -->
            <div class="mb-6"> <!-- Reduced margin -->
                <h3 class="section-title">Exercises</h3>
                <ul id="workout-exercise-list" class="space-y-3">
                    <!-- Generated by JS -->
                </ul>
            </div>

            <!-- Controls -->
            <div id="workout-controls" class="space-y-4">
                <button id="pause-resume-btn" class="btn btn-primary">Pause</button>
                <button id="end-workout-btn" class="btn btn-danger">End Workout</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- GLOBAL STATE ---
            let workoutConfig = {
                format: 'amrap',
                time: null,
                rounds: null,
                exercises: []
            };
            let timerInterval = null; // Holds the setInterval ID
            
            // --- CONSOLIDATED TIMER STATE ---
            let totalSeconds = 0;
            let secondsRemaining = 0;
            let secondsElapsed = 0;
            let isPaused = false;
            let currentRound = 1; // For AMRAP/RFT
            let currentMinute = 1; // For EMOM
            let timerMode = 'countdown'; // 'countdown' or 'stopwatch'


            // --- CONSOLIDATED DOM ELEMENTS ---
            const builderScreen = document.getElementById('builder-screen');
            const workoutScreen = document.getElementById('workout-screen');
            const countdownOverlay = document.getElementById('countdown-overlay');
            const countdownText = document.getElementById('countdown-text');
            
            // Builder Screen
            const formatSelect = document.getElementById('workout-format');
            const formatOptionsContainer = document.getElementById('format-options');
            const exerciseDetailsContainer = document.getElementById('exercise-details');
            const exerciseNameInput = document.getElementById('exercise-name');
            const addExerciseBtn = document.getElementById('add-exercise-btn');
            const summaryContainer = document.getElementById('workout-summary');
            const summaryHeader = document.getElementById('summary-header');
            const summaryList = document.getElementById('summary-list');
            const startWorkoutBtn = document.getElementById('start-workout-btn');
            
            // Workout Screen
            const workoutTitle = document.getElementById('workout-title');
            const mainTimerDisplay = document.getElementById('main-timer');
            const secondaryInfoLabel = document.getElementById('secondary-info-label');
            const secondaryInfoValue = document.getElementById('secondary-info-value');
            const workoutExerciseList = document.getElementById('workout-exercise-list');
            const pauseResumeBtn = document.getElementById('pause-resume-btn');
            const endWorkoutBtn = document.getElementById('end-workout-btn');


            // --- FUNCTIONS ---
            
            /**
             * Flashes a red border on an element for validation feedback
             * @param {HTMLElement} el The element to flash
             */
            function flashInvalid(el) {
                if (!el) return;
                el.classList.add('invalid');
                setTimeout(() => {
                    el.classList.remove('invalid');
                }, 1500);
            }
            
            /**
             * Formats seconds into MM:SS
             * @param {number} s - Total seconds
             */
            function formatTime(s) {
                const minutes = Math.floor(s / 60);
                const seconds = s % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // --- BUILDER FUNCTIONS ---

            /**
             * Updates the UI inputs based on the selected workout format.
             */
            function updateFormatOptions() {
                const format = formatSelect.value;
                workoutConfig.format = format;
                
                // Clear previous options
                formatOptionsContainer.innerHTML = '';
                exerciseDetailsContainer.innerHTML = '';

                let formatOptionsHTML = '';
                let exerciseDetailsHTML = '';

               // All formats will now use a single "Reps" input
               exerciseDetailsHTML = `
                   <div class="flex-1">
                       <label for="exercise-reps" class="form-label">Reps</label>
                       <input type="number" id="exercise-reps" class="form-input" placeholder="e.g., 10">
                   </div>
               `;

                switch (format) {
                    case 'amrap':
                        formatOptionsHTML = `
                            <div>
                                <label for="workout-time" class="form-label">2. Set Time</label>
                                <input type="number" id="workout-time" class="form-input" placeholder="Time (minutes)">
                            </div>
                        `;
                        break;
                    
                    case 'emom':
                        formatOptionsHTML = `
                            <div>
                                <label for="workout-time" class="form-label">2. Set Time</label>
                                <input type="number" id="workout-time" class="form-input" placeholder="Total Minutes">
                            </div>
                        `;
                        break;

                    case 'rft':
                        formatOptionsHTML = `
                            <div>
                                <label for="workout-rounds" class="form-label">2. Set Rounds</label>
                                <input type="number" id="workout-rounds" class="form-input" placeholder="e.g., 5">
                            </div>
                        `;
                        break;

                   case 'chipper':
                       formatOptionsHTML = `<p class="form-label text-center mb-4">2. Add exercises to complete for time</p>`;
                       // exerciseDetailsHTML is already set above
                        break;
                }

                formatOptionsContainer.innerHTML = formatOptionsHTML;
                exerciseDetailsContainer.innerHTML = exerciseDetailsHTML;

                // Add event listeners to new inputs
                addFormatInputListeners();
            }

            /**
             * Adds event listeners to the dynamically created format inputs.
             */
            function addFormatInputListeners() {
                const timeInput = document.getElementById('workout-time');
                const roundsInput = document.getElementById('workout-rounds');

                if (timeInput) {
                    timeInput.addEventListener('input', (e) => {
                        workoutConfig.time = e.target.value ? parseInt(e.target.value, 10) : null;
                        renderWorkoutSummary();
                    });
                }
                if (roundsInput) {
                    roundsInput.addEventListener('input', (e) => {
                        workoutConfig.rounds = e.target.value ? parseInt(e.target.value, 10) : null;
                        renderWorkoutSummary();
                    });
                }
            }

            /**
             * Adds a new exercise to the config object from the inputs.
             */
            function addExercise() {
                const name = exerciseNameInput.value.trim();
                const repsInput = document.getElementById('exercise-reps');
                const reps = repsInput ? repsInput.value.trim() : '';

                // Validation
                if (!name) {
                    flashInvalid(exerciseNameInput);
                    return;
                }
                if (!reps) {
                    flashInvalid(repsInput);
                    return;
                }

                const newExercise = { name, reps };
                workoutConfig.exercises.push(newExercise);
                
                // Clear inputs
                exerciseNameInput.value = '';
                if (repsInput) repsInput.value = '';
                
                exerciseNameInput.focus();
                
                // Update the summary
                renderWorkoutSummary();
            }

            /**
             * Renders the entire workout summary based on the config object.
             */
            function renderWorkoutSummary() {
                // Show the summary box if it's hidden
                if (workoutConfig.exercises.length > 0 || workoutConfig.time || workoutConfig.rounds) {
                    summaryContainer.classList.remove('hidden');
                } else {
                    summaryContainer.classList.add('hidden'); // Hide if nothing is configured
                }


                // 1. Update Header
                let headerText = '';
                const { format, time, rounds } = workoutConfig;
                switch (format) {
                    case 'amrap':
                        headerText = time ? `${time} MINUTE AMRAP` : 'AMRAP';
                        break;
                    case 'emom':
                        headerText = time ? `${time} MINUTE EMOM` : 'EMOM';
                        break;
                    case 'rft':
                        headerText = rounds ? `${rounds} ROUNDS FOR TIME` : 'ROUNDS FOR TIME';
                        break;
                   case 'chipper':
                       headerText = 'CHIPPER (FOR TIME)';
                        break;
                }
                summaryHeader.textContent = headerText;

                // 2. Update Exercise List
                summaryList.innerHTML = '';
                if (workoutConfig.exercises.length === 0) {
                    summaryList.innerHTML = `<li class="text-sm text-secondary-text p-3 text-center">No exercises added yet.</li>`;
                    return;
                }

                workoutConfig.exercises.forEach((ex, index) => {
                    let details = `${ex.reps} reps`;
                    
                    const li = document.createElement('li');
                    li.className = "exercise-item";
                    li.innerHTML = `
                        <span class="text-white font-medium">
                            ${ex.name}
                            <span class="exercise-item-details">(${details})</span>
                        </span>
                        <button class="btn-remove" data-index="${index}">Remove</button>
                    `;
                    summaryList.appendChild(li);
                });
            }

            /**
             * Handles clicks on the summary list (for remove buttons).
             */
            function handleSummaryClick(e) {
                if (e.target.classList.contains('btn-remove')) {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    workoutConfig.exercises.splice(indexToRemove, 1);
                    renderWorkoutSummary();
                }
            }


            // --- WORKOUT TIMER FUNCTIONS ---
            
            /**
             * Shows/Hides the main screens
             */
            function showScreen(screenId) {
                builderScreen.classList.add('hidden');
                workoutScreen.classList.add('hidden');
                
                if (screenId === 'builder') {
                    builderScreen.classList.remove('hidden');
                } else if (screenId === 'workout') {
                    workoutScreen.classList.remove('hidden');
                }
            }

            /**
             * Validates the workout config before starting
             */
            function validateConfig() {
                const { format, time, rounds, exercises } = workoutConfig;
                
                if (exercises.length === 0) {
                    flashInvalid(addExerciseBtn); // Flash the "Add" button if no exercises
                    return false;
                }
                if (format === 'amrap' || format === 'emom') {
                    const timeInput = document.getElementById('workout-time');
                    if (!time || time <= 0) {
                        if (timeInput) flashInvalid(timeInput);
                        return false;
                    }
                }
                if (format === 'rft') {
                    const roundsInput = document.getElementById('workout-rounds');
                    if (!rounds || rounds <= 0) {
                        if (roundsInput) flashInvalid(roundsInput);
                        return false;
                    }
                }
                return true;
            }

            /**
             * Populates the workout screen with config data
             */
            function setupWorkoutScreen() {
                const { format, time, rounds, exercises } = workoutConfig;
                
                // 1. Set Title
                workoutTitle.textContent = summaryHeader.textContent; // Use same header text

                // 2. Set Timer & Mode
                isPaused = false;
                pauseResumeBtn.textContent = 'Pause';
                pauseResumeBtn.classList.remove('!bg-green-600', 'hover:!bg-green-700');
                pauseResumeBtn.disabled = false;
                secondsElapsed = 0;
                currentRound = 1;
                currentMinute = 1;

                switch (format) {
                    case 'amrap':
                    case 'emom':
                        timerMode = 'countdown';
                        totalSeconds = time * 60;
                        secondsRemaining = totalSeconds;
                        mainTimerDisplay.textContent = formatTime(secondsRemaining);
                        break;
                    case 'rft':
                    case 'chipper':
                        timerMode = 'stopwatch';
                        secondsRemaining = 0; // Not used
                        mainTimerDisplay.textContent = '00:00';
                        break;
                }

                // 3. Set Secondary Info
                if (format === 'emom') {
                    secondaryInfoLabel.textContent = 'CURRENT MINUTE';
                    secondaryInfoValue.textContent = currentMinute;
                } else if (format === 'rft') {
                    secondaryInfoLabel.textContent = `ROUND (OF ${rounds})`;
                    secondaryInfoValue.textContent = currentRound;
                } else if (format === 'amrap') {
                    secondaryInfoLabel.textContent = 'CURRENT ROUND';
                    secondaryInfoValue.textContent = currentRound;
                } else { // Chipper
                    secondaryInfoLabel.textContent = 'FOR TIME';
                    secondaryInfoValue.textContent = '1';
                }

                // 4. Populate Exercise List
                workoutExerciseList.innerHTML = '';
                exercises.forEach((ex, index) => {
                    const li = document.createElement('li');
                    li.className = "exercise-item !justify-center"; // Center items
                    // Add active class to first item for EMOM/Chipper
                    if ((format === 'emom' || format === 'chipper') && index === 0) {
                        li.classList.add('active');
                    }
                    li.innerHTML = `
                        <span class="text-white font-medium text-lg">
                            ${ex.name}
                            <span class="exercise-item-details">(${ex.reps} reps)</span>
                        </span>
                    `;
                    workoutExerciseList.appendChild(li);
                });
            }

            /**
             * Starts the 3-second countdown
             */
            function startCountdown() {
                countdownOverlay.classList.remove('hidden');
                let count = 3;
                countdownText.textContent = count;
                
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownText.textContent = count;
                    } else if (count === 0) {
                        countdownText.textContent = 'GO!';
                    } else {
                        clearInterval(countdownInterval);
                        countdownOverlay.classList.add('hidden');
                        runTimer();
                    }
                }, 1000);
            }

            /**
             * The main timer loop
             */
            function runTimer() {
                clearInterval(timerInterval); // Clear any existing interval
                
                timerInterval = setInterval(() => {
                    if (isPaused) return;

                    if (timerMode === 'countdown') {
                        secondsRemaining--;
                        mainTimerDisplay.textContent = formatTime(secondsRemaining);

                        // EMOM-specific logic
                        if (workoutConfig.format === 'emom') {
                            const secondsIntoMinute = 60 - (secondsRemaining % 60);
                            if (secondsIntoMinute === 60 || secondsRemaining === 0) { // New minute
                                currentMinute = Math.floor((totalSeconds - secondsRemaining) / 60) + 1;
                                if (secondsRemaining > 0) {
                                    secondaryInfoValue.textContent = currentMinute;
                                }
                                // Highlight active exercise
                                document.querySelectorAll('#workout-exercise-list .exercise-item').forEach((item, index) => {
                                    item.classList.toggle('active', (currentMinute - 1) % workoutConfig.exercises.length === index);
                                });
                            }
                        }

                        if (secondsRemaining <= 0) {
                            clearInterval(timerInterval);
                            mainTimerDisplay.textContent = 'DONE!';
                            pauseResumeBtn.disabled = true;
                            // Add a "finished" sound
                        }
                    } else { // 'stopwatch'
                        secondsElapsed++;
                        mainTimerDisplay.textContent = formatTime(secondsElapsed);
                    }
                }, 1000);
            }

            /**
             * Toggles the timer pause state
             */
            function togglePause() {
                isPaused = !isPaused;
                pauseResumeBtn.textContent = isPaused ? 'Resume' : 'Pause';
                pauseResumeBtn.classList.toggle('!bg-green-600', isPaused);
                pauseResumeBtn.classList.toggle('hover:!bg-green-700', isPaused);
            }

            /**
             * Ends the workout and returns to the builder
             */
            function endWorkout() {
                clearInterval(timerInterval);
                timerInterval = null;
                showScreen('builder');
                // Reset timer screen for next time
                mainTimerDisplay.textContent = '00:00';
            }


            /**
             * Handles the main "Start Workout" button click
             */
            function handleStartWorkout() {
                if (!validateConfig()) {
                    console.warn('Workout config is invalid.');
                    return;
                }
                
                // 1. Setup the screen with data
                setupWorkoutScreen();
                
                // 2. Show the workout screen
                showScreen('workout');
                
                // 3. Start the countdown
                startCountdown();
            }

            // --- INITIALIZATION ---
            formatSelect.addEventListener('change', () => {
                updateFormatOptions();
                renderWorkoutSummary(); // Re-render header when format changes
            });
            addExerciseBtn.addEventListener('click', addExercise);
            summaryList.addEventListener('click', handleSummaryClick);
            startWorkoutBtn.addEventListener('click', handleStartWorkout);
            
            // --- WORKOUT SCREEN LISTENERS ---
            pauseResumeBtn.addEventListener('click', togglePause);
            endWorkoutBtn.addEventListener('click', endWorkout);

            // Initial setup
            updateFormatOptions();
            renderWorkoutSummary();
        });
    </script>
</body>
</html>


c
