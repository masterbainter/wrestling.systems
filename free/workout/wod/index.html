<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOD Track | Build Strength Anywhere</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000; /* Pure Black */
            color: #e5e7eb; /* Gray-200 */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ca8a04; /* Amber-600 */
        }

        /* Rep Down Specific Styles */
        .text-glow {
            text-shadow: 0 0 10px currentColor;
        }
        
        .container-glow {
            box-shadow: 0 0 30px rgba(250, 204, 21, 0.15), inset 0 0 20px rgba(250, 204, 21, 0.05);
            border: 1px solid rgba(250, 204, 21, 0.3);
        }
        
        .btn-glow {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.2);
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.6);
        }

        .exercise-card {
            transition: all 0.3s ease;
        }
        .exercise-card:hover {
            transform: translateY(-2px);
            border-color: rgba(250, 204, 21, 0.6);
        }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Modal Styles */
        .modal-overlay {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Gold Color for modal */
        .bg-gold-500 { background-color: #D4AF37; }
        .hover\:bg-gold-600:hover { background-color: #C09B2D; }
        .text-gold-300 { color: #E6C75E; }
        .focus\:ring-gold-500:focus { --tw-ring-color: #D4AF37; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 bg-black bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-900 via-black to-black">

    <!-- Main Container -->
    <main class="w-full max-w-2xl bg-gray-900/80 backdrop-blur-md rounded-2xl container-glow overflow-hidden relative">
        
        <!-- Header Section -->
        <header class="p-6 sm:p-8 text-center border-b border-gray-800 relative">
            
            <!-- Auth Status / Login -->
            <div class="absolute top-4 right-4 flex items-center gap-3">
                <div id="auth-loading" class="animate-pulse text-amber-400 text-xs font-mono">Connecting...</div>
                
                <div id="user-info" class="hidden flex items-center gap-3 bg-gray-900 border border-gray-700 rounded-full px-3 py-1">
                    <img id="user-avatar" src="" alt="User" class="w-6 h-6 rounded-full hidden">
                    <span id="user-name" class="text-xs text-gray-400 font-bold hidden sm:block">User</span>
                    <button id="btn-logout" class="text-xs text-red-400 hover:text-white transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>

                <button id="btn-login" class="hidden flex items-center gap-2 bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-full font-bold text-xs transition-colors shadow-lg">
                    <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81Z"/></svg>
                    Sign In
                </button>
            </div>

            <div class="flex justify-center items-center gap-3 mb-2 mt-4 sm:mt-0">
                <i data-lucide="dumbbell" class="w-10 h-10 text-amber-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.8)]"></i>
                <h1 class="text-4xl font-extrabold text-amber-400 tracking-tight text-glow uppercase italic">WOD Track</h1>
            </div>
            <p class="text-gray-400 font-medium">Build Strength Anywhere.</p>
        </header>

        <!-- Timer Section -->
        <div class="bg-black/40 border-b border-gray-800 p-8 flex flex-col items-center justify-center sticky top-0 z-20 backdrop-blur-sm relative">
            
            <!-- Visible Mode Toggles -->
            <div class="flex w-full max-w-md bg-gray-900 rounded-lg p-1 mb-6 border border-gray-700 shadow-lg">
                <button id="mode-fortime" class="flex-1 py-2 text-xs sm:text-sm font-bold rounded-md transition-all bg-amber-400 text-black shadow-sm uppercase tracking-wider">For Time</button>
                <button id="mode-amrap" class="flex-1 py-2 text-xs sm:text-sm font-bold rounded-md transition-all text-gray-500 hover:text-gray-300 uppercase tracking-wider">AMRAP</button>
                <button id="mode-emom" class="flex-1 py-2 text-xs sm:text-sm font-bold rounded-md transition-all text-gray-500 hover:text-gray-300 uppercase tracking-wider">EMOM</button>
            </div>

            <!-- Inputs Container -->
            <div id="timer-inputs-container" class="min-h-[3rem] mb-2 flex justify-center items-center">
                
                <!-- AMRAP Input -->
                <div id="input-group-amrap" class="hidden flex items-center gap-3 bg-gray-900/50 p-2 rounded-lg border border-gray-700 animate-in fade-in slide-in-from-top-2 duration-200">
                    <label class="text-xs text-amber-400 font-bold uppercase tracking-wider pl-2">Time Cap (Min):</label>
                    <input type="number" id="input-amrap-minutes" value="10" min="1" max="90" class="w-16 bg-black border border-gray-700 rounded-md p-1 text-white text-center font-bold text-lg focus:border-amber-400 focus:outline-none transition-colors">
                </div>

                <!-- EMOM Input -->
                <div id="input-group-emom" class="hidden flex items-center gap-3 bg-gray-900/50 p-2 rounded-lg border border-gray-700 animate-in fade-in slide-in-from-top-2 duration-200">
                    <label class="text-xs text-amber-400 font-bold uppercase tracking-wider pl-2">Every (Min):</label>
                    <input type="number" id="input-emom-interval" value="1" min="1" max="10" class="w-16 bg-black border border-gray-700 rounded-md p-1 text-white text-center font-bold text-lg focus:border-amber-400 focus:outline-none transition-colors">
                    <span class="text-xs text-gray-500 font-bold">|</span>
                    <span id="emom-round-display" class="text-xs text-cyan-400 font-bold uppercase tracking-wider pr-2">Interval 1</span>
                </div>

            </div>

            <div id="timer-display" class="text-7xl font-mono font-bold tracking-wider mb-6 tabular-nums text-amber-400 text-glow cursor-default">00:00</div>
            
            <div class="flex gap-4 w-full justify-center">
                <button id="btn-start" class="flex-1 max-w-[140px] flex justify-center items-center gap-2 bg-transparent border-2 border-amber-400 text-amber-400 hover:bg-amber-400 hover:text-black px-6 py-3 rounded-xl font-bold transition-all btn-glow uppercase tracking-wider">
                    <i data-lucide="play" class="w-5 h-5"></i> Start
                </button>
                <button id="btn-pause" class="hidden flex-1 max-w-[140px] flex justify-center items-center gap-2 bg-transparent border-2 border-cyan-400 text-cyan-400 hover:bg-cyan-400 hover:text-black px-6 py-3 rounded-xl font-bold transition-all uppercase tracking-wider shadow-[0_0_10px_rgba(34,211,238,0.3)] hover:shadow-[0_0_20px_rgba(34,211,238,0.6)]">
                    <i data-lucide="pause" class="w-5 h-5"></i> Pause
                </button>
                <button id="btn-reset-timer" class="flex items-center justify-center gap-2 bg-transparent border-2 border-gray-700 hover:border-gray-500 text-gray-500 hover:text-gray-300 px-4 py-3 rounded-xl font-bold transition-colors">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Round Time Indicator -->
            <p class="mt-4 text-xs text-gray-500 uppercase tracking-widest font-bold opacity-60" id="timer-label">Stopwatch Time</p>
        </div>

        <!-- Dashboard Stats -->
        <div class="grid grid-cols-3 gap-px bg-gray-800 border-b border-gray-800">
            <div class="bg-gray-900/60 p-4 text-center group hover:bg-gray-800 transition-colors">
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Rounds</p>
                <p id="stat-rounds" class="text-3xl font-bold text-amber-400 text-glow">0</p>
            </div>
            <div class="bg-gray-900/60 p-4 text-center group hover:bg-gray-800 transition-colors">
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Total Reps</p>
                <p id="stat-reps" class="text-3xl font-bold text-cyan-400 drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">0</p>
            </div>
            <div class="bg-gray-900/60 p-4 text-center group hover:bg-gray-800 transition-colors">
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Exercises</p>
                <p id="stat-count" class="text-3xl font-bold text-gray-200">0</p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="p-6 bg-transparent space-y-4">
            <div class="relative">
                <div class="flex gap-3">
                    <div class="relative flex-grow">
                        <input type="text" id="exercise-search" placeholder="Add Exercise (e.g., 'Pushups')" 
                            class="w-full p-4 bg-gray-800 border-2 border-gray-700 text-white rounded-xl focus:border-amber-400 focus:ring-1 focus:ring-amber-400 focus:outline-none transition-all placeholder-gray-500 font-bold text-lg" autocomplete="off">
                        <!-- Autocomplete Dropdown -->
                        <ul id="search-suggestions" class="absolute left-0 right-0 top-full mt-2 bg-gray-900 border border-gray-700 rounded-xl shadow-2xl z-30 max-h-60 overflow-y-auto hidden">
                            <!-- Suggestions injected here -->
                        </ul>
                    </div>
                    <input type="number" id="default-reps" placeholder="10" value="10" min="1"
                        class="w-24 p-4 bg-gray-800 border-2 border-gray-700 text-amber-400 rounded-xl focus:border-amber-400 focus:ring-1 focus:ring-amber-400 focus:outline-none text-center font-bold text-xl">
                    <button id="btn-add-exercise" class="bg-gray-800 hover:bg-gray-700 border-2 border-gray-700 hover:border-amber-400 text-amber-400 p-4 rounded-xl transition-all">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Active Workout List -->
        <div id="workout-list" class="px-6 pb-6 space-y-4 min-h-[100px]">
            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 opacity-40 border-2 border-dashed border-gray-800 rounded-xl">
                <i data-lucide="clipboard-list" class="w-16 h-16 mx-auto text-gray-600 mb-4"></i>
                <p class="text-gray-500 text-lg">No exercises added.<br>Search above to start.</p>
            </div>
        </div>

        <!-- Controls Footer -->
        <div class="p-6 bg-black/60 border-t border-gray-800 flex flex-col gap-4 backdrop-blur-md">
            <button id="btn-next-round" class="w-full bg-transparent hover:bg-amber-400 text-amber-400 hover:text-black py-4 px-6 rounded-xl font-bold text-xl border-2 border-amber-400 transition-all btn-glow flex justify-center items-center gap-3 uppercase tracking-wide">
                Start Next Round <i data-lucide="arrow-right" class="w-6 h-6"></i>
            </button>
            <button id="btn-finish-workout" class="w-full text-red-500 hover:text-red-400 font-semibold text-sm transition-colors flex justify-center items-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i> End & Save Workout
            </button>
        </div>

        <!-- History Toggle -->
        <div class="bg-gray-900 border-t border-gray-800">
            <button id="btn-toggle-history" class="w-full p-3 text-sm text-gray-500 hover:text-amber-400 font-medium flex items-center justify-center gap-2 transition-colors">
                <span>View History</span>
                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform" id="history-arrow"></i>
            </button>
        </div>

        <!-- History Section (Hidden by default) -->
        <div id="history-section" class="hidden border-t border-gray-800 bg-black p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-amber-400 text-glow">Past Workouts</h3>
                <div id="auth-warning" class="text-xs text-red-400 hidden">Sign in to sync history</div>
            </div>
            <div id="history-list" class="space-y-4">
                <!-- History Items injected here -->
            </div>
        </div>

    </main>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay bg-black/80">
        <div class="modal-content w-full max-w-md bg-gray-900 backdrop-blur-sm rounded-2xl shadow-2xl border border-amber-400/30">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">Sign In / Sign Up</h2>
                <button id="btn-close-modal" class="text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <p class="text-gray-400 text-center mb-6">Choose your sign-in method to save your workouts</p>

                <!-- Social Logins -->
                <div class="space-y-3 mb-6">
                    <button id="modal-google-signin" class="w-full flex items-center justify-center py-3 px-4 border border-gray-600 rounded-lg shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                        <svg class="w-5 h-5 mr-3 text-gold-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 172.9 60.3L360 128.2c-23.2-21.5-58.2-34.6-112-34.6-88.6 0-161.2 71.5-161.2 162.3s72.6 162.3 161.2 162.3c98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 26.9 3.9 41.4z"></path></svg>
                        <span>Continue with Google</span>
                    </button>
                    <button id="modal-facebook-signin" class="w-full flex items-center justify-center py-3 px-4 border border-gray-600 rounded-lg shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                        <svg class="w-5 h-5 mr-3 text-gold-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg>
                        <span>Continue with Facebook</span>
                    </button>
                    <button id="modal-microsoft-signin" class="w-full flex items-center justify-center py-3 px-4 border border-gray-600 rounded-lg shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                        <svg class="w-5 h-5 mr-3 text-gold-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 32h192v192H0V32zm256 0h192v192H256V32zM0 288h192v192H0V288zm256 288h192v-96H256v96zm0-128h192v-96H256v96z"></path></svg>
                        <span>Continue with Microsoft</span>
                    </button>
                </div>

                <!-- Divider -->
                <div class="flex items-center mb-6">
                    <div class="flex-grow border-t border-gray-700"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-sm">Or sign up with email</span>
                    <div class="flex-grow border-t border-gray-700"></div>
                </div>

                <!-- Email/Password Form -->
                <form id="modal-signup-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="modal-firstName" class="block text-sm font-medium text-gray-300 mb-1">First Name</label>
                            <input type="text" id="modal-firstName" name="firstName" required
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500">
                        </div>
                        <div>
                            <label for="modal-lastName" class="block text-sm font-medium text-gray-300 mb-1">Last Name</label>
                            <input type="text" id="modal-lastName" name="lastName" required
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500">
                        </div>
                    </div>
                    <div>
                        <label for="modal-email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="modal-email" name="email" required
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500">
                    </div>
                    <div>
                        <label for="modal-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="modal-password" name="password" required minlength="6"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500">
                    </div>
                    <div>
                        <button type="submit" id="modal-submit-button"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-black bg-gold-500 hover:bg-gold-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                            Create Account
                        </button>
                    </div>
                </form>

                <p id="modal-error-message" class="text-red-400 text-sm text-center mt-4"></p>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            FacebookAuthProvider,
            OAuthProvider,
            signOut,
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously,
            createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

        // --- Data & State ---
        let app, auth, db, user, unsubscribeHistory;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'wod-track-default';
        
        const PREDEFINED_EXERCISES = [
            "Air Squats", "Back Squats", "Bar Muscle-ups", "Bench Press", "Box Jumps", 
            "Burpees", "Clean & Jerk", "Deadlifts", "Double Unders", "Dumbbell Snatch", 
            "Front Squats", "Handstand Push-ups", "Handstand Walk", "Jumping Jacks", 
            "Kettlebell Swings", "Lunges", "Muscle-ups", "Overhead Squats", "Pistol Squats", 
            "Plank (sec)", "Pull-ups", "Push-ups", "Ring Dips", "Rope Climbs", "Rowing (cal)", 
            "Running (m)", "Sit-ups", "Snatch", "Strict Press", "Thrusters", "Toes-to-Bar", 
            "Wall Balls", "Walking Lunges", "V-ups"
        ];

        let state = {
            currentRound: 0,
            accumulatedReps: 0,
            exercises: [], 
            roundHistory: [],
            timer: {
                interval: null,
                startTime: 0,
                elapsed: 0,
                isRunning: false,
                mode: 'fortime', // 'fortime', 'amrap', 'emom'
                amrapCap: 10,
                emomInterval: 1
            }
        };

        // --- DOM Elements ---
        const els = {
            inputSearch: document.getElementById('exercise-search'),
            inputReps: document.getElementById('default-reps'),
            listSuggestions: document.getElementById('search-suggestions'),
            btnAdd: document.getElementById('btn-add-exercise'),
            workoutList: document.getElementById('workout-list'),
            emptyState: document.getElementById('empty-state'),
            timerDisplay: document.getElementById('timer-display'),
            timerLabel: document.getElementById('timer-label'),
            btnStart: document.getElementById('btn-start'),
            btnPause: document.getElementById('btn-pause'),
            btnResetTimer: document.getElementById('btn-reset-timer'),
            btnNextRound: document.getElementById('btn-next-round'),
            btnFinish: document.getElementById('btn-finish-workout'),
            statRounds: document.getElementById('stat-rounds'),
            statReps: document.getElementById('stat-reps'),
            statCount: document.getElementById('stat-count'),
            historySection: document.getElementById('history-section'),
            historyList: document.getElementById('history-list'),
            btnToggleHistory: document.getElementById('btn-toggle-history'),
            historyArrow: document.getElementById('history-arrow'),
            
            // Timer Settings
            btnModeFortime: document.getElementById('mode-fortime'),
            btnModeAmrap: document.getElementById('mode-amrap'),
            btnModeEmom: document.getElementById('mode-emom'),
            
            groupInputAmrap: document.getElementById('input-group-amrap'),
            inputAmrapMinutes: document.getElementById('input-amrap-minutes'),
            
            groupInputEmom: document.getElementById('input-group-emom'),
            inputEmomInterval: document.getElementById('input-emom-interval'),
            emomRoundDisplay: document.getElementById('emom-round-display'),

            // Auth Elements
            authLoading: document.getElementById('auth-loading'),
            userInfo: document.getElementById('user-info'),
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            btnLogin: document.getElementById('btn-login'),
            btnLogout: document.getElementById('btn-logout'),
            authWarning: document.getElementById('auth-warning'),

            // Modal Elements
            authModal: document.getElementById('auth-modal'),
            btnCloseModal: document.getElementById('btn-close-modal'),
            modalGoogleSignin: document.getElementById('modal-google-signin'),
            modalFacebookSignin: document.getElementById('modal-facebook-signin'),
            modalMicrosoftSignin: document.getElementById('modal-microsoft-signin'),
            modalSignupForm: document.getElementById('modal-signup-form'),
            modalSubmitButton: document.getElementById('modal-submit-button'),
            modalErrorMessage: document.getElementById('modal-error-message')
        };

        // --- Initialization ---
        initFirebase();
        lucide.createIcons();
        updateTimerDisplay();

        async function initFirebase() {
            try {
                // The provided specific config
                const customConfig = {
                  apiKey: "AIzaSyASn9xe5RRKFGXNi-Vha-NunDYj1mv7D3g",
                  authDomain: "auth.wrestling.systems",
                  projectId: "wrestlingsystems",
                  storageBucket: "wrestlingsystems.firebasestorage.app",
                  messagingSenderId: "255692661115",
                  appId: "1:255692661115:web:c2df7cf79d3eb14b20ddde",
                  measurementId: "G-EXTT24L66R"
                };

                // Logic: Use environment config if available (for preview), else use custom
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                    ? JSON.parse(__firebase_config) 
                    : customConfig;

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Initialize App Check with reCAPTCHA v3
                const appCheck = initializeAppCheck(app, {
                    provider: new ReCaptchaV3Provider('6Ler2pgrAAAAAAQwDvNoe4voerXxtlVTwvdi0sg2'),
                    isTokenAutoRefreshEnabled: true
                });

                // Handle Auth Flow - Immediate check/login
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Fallback to anonymous login so DB works immediately
                    // The user can still click "Sign In" to upgrade to Google later
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                             await signInAnonymously(auth);
                        }
                    });
                }

                onAuthStateChanged(auth, (currentUser) => {
                    user = currentUser;
                    updateAuthUI();
                    if (user) {
                        setupHistoryListener();
                    } else {
                        els.historyList.innerHTML = '<p class="text-gray-600 text-sm text-center py-4">Sign in to view workout history.</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                els.authLoading.textContent = "Offline Mode";
            }
        }

        // --- Auth Functions ---

        // Modal Control Functions
        function openAuthModal() {
            els.authModal.classList.remove('hidden');
            els.modalErrorMessage.textContent = '';
            document.body.style.overflow = 'hidden';
        }

        function closeAuthModal() {
            els.authModal.classList.add('hidden');
            document.body.style.overflow = '';
            els.modalSignupForm.reset();
            els.modalErrorMessage.textContent = '';
        }

        // Helper function to create user in Firestore after social sign-in
        async function createSocialUserInFirestore(user) {
            try {
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    const nameParts = user.displayName ? user.displayName.split(' ') : ['', ''];
                    const firstName = nameParts[0];
                    const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';

                    await setDoc(userRef, {
                        firstName: firstName,
                        lastName: lastName,
                        email: user.email,
                        createdAt: new Date(),
                        provider: user.providerData[0].providerId
                    });
                }
            } catch (error) {
                console.error("Failed to save user data:", error);
                throw error;
            }
        }

        // Social Sign-in Handler
        async function handleSocialSignIn(provider, providerName) {
            if (!auth) return;
            els.modalErrorMessage.textContent = '';

            try {
                const result = await signInWithPopup(auth, provider);
                await createSocialUserInFirestore(result.user);
                closeAuthModal();
                showToast("Signed in successfully!", "success");
            } catch (error) {
                console.error(`${providerName} Login Failed:`, error);
                let friendlyMessage = `Could not sign in with ${providerName}. Please try again.`;

                if (error.code === 'auth/account-exists-with-different-credential') {
                    friendlyMessage = "An account already exists with this email. Please sign in with your original method.";
                } else if (error.code.includes('app-check')) {
                    friendlyMessage = 'Could not verify you are human. Please refresh and try again.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    friendlyMessage = 'Authentication domain not authorized. Please contact support.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'Sign-in cancelled.';
                } else if (error.code === 'permission-denied') {
                    friendlyMessage = 'Failed to save user data. Please contact support.';
                }

                els.modalErrorMessage.textContent = friendlyMessage;
            }
        }

        // Email/Password Sign-up Handler
        async function handleEmailSignup(e) {
            e.preventDefault();
            if (!auth || !db) return;

            els.modalSubmitButton.disabled = true;
            els.modalSubmitButton.textContent = 'Creating Account...';
            els.modalErrorMessage.textContent = '';

            const formData = new FormData(els.modalSignupForm);
            const firstName = formData.get('firstName');
            const lastName = formData.get('lastName');
            const email = formData.get('email');
            const password = formData.get('password');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, "users", user.uid), {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    createdAt: new Date()
                });

                closeAuthModal();
                showToast("Account created successfully!", "success");
            } catch (error) {
                console.error("Signup Failed:", error);
                let friendlyMessage = "An unexpected error occurred.";

                if (error.code === 'auth/email-already-in-use') {
                    friendlyMessage = 'This email address is already registered.';
                } else if (error.code === 'auth/weak-password') {
                    friendlyMessage = 'Password should be at least 6 characters long.';
                } else if (error.code.includes('app-check')) {
                    friendlyMessage = 'Could not verify you are human. Please refresh and try again.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    friendlyMessage = 'Authentication domain not authorized. Please contact support.';
                } else if (error.code === 'permission-denied') {
                    friendlyMessage = 'Failed to save user data. Please contact support.';
                }

                els.modalErrorMessage.textContent = friendlyMessage;
            } finally {
                els.modalSubmitButton.disabled = false;
                els.modalSubmitButton.textContent = 'Create Account';
            }
        }

        async function logout() {
            if (!auth) return;
            try {
                await signOut(auth);
                // Clean up listeners
                if(unsubscribeHistory) unsubscribeHistory();
                // Re-trigger anonymous login so app remains usable
                await signInAnonymously(auth); 
                showToast("Signed out", "neutral");
            } catch (error) {
                console.error("Logout Failed:", error);
            }
        }

        function updateAuthUI() {
            els.authLoading.classList.add('hidden');
            
            // Check if user is anonymous or authenticated
            const isAnonymous = user?.isAnonymous;
            
            if (user && !isAnonymous) {
                els.btnLogin.classList.add('hidden');
                els.userInfo.classList.remove('hidden');
                els.userInfo.classList.add('flex');
                els.userName.textContent = user.displayName || "User";
                if (user.photoURL) {
                    els.userAvatar.src = user.photoURL;
                    els.userAvatar.classList.remove('hidden');
                } else {
                    els.userAvatar.classList.add('hidden');
                }
                els.authWarning.classList.add('hidden');
            } else {
                // Anonymous or Not Logged In
                els.userInfo.classList.add('hidden');
                els.userInfo.classList.remove('flex');
                els.btnLogin.classList.remove('hidden');
                // Don't show auth warning if anonymous, as they can still save data locally/session
                els.authWarning.classList.add('hidden'); 
            }
        }

        // --- History & Storage (Firestore) ---

        function setupHistoryListener() {
            if (!user || !db) return;

            // RULE 1: Use specific path structure
            const workoutsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'workouts');
            
            // RULE 2: Simple query (Sort in memory to avoid index errors)
            const q = query(workoutsRef);

            unsubscribeHistory = onSnapshot(q, (snapshot) => {
                els.historyList.innerHTML = '';
                
                const workouts = [];
                snapshot.forEach((doc) => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });

                // Sort in memory (Newest first)
                workouts.sort((a, b) => {
                    const ta = a.timestamp?.toMillis() || 0;
                    const tb = b.timestamp?.toMillis() || 0;
                    return tb - ta;
                });

                if (workouts.length === 0) {
                    els.historyList.innerHTML = '<p class="text-gray-600 italic text-sm text-center">No workout history found.</p>';
                    return;
                }

                workouts.forEach(w => renderHistoryItem(w));
                
            }, (error) => {
                console.error("History Sync Error:", error);
                els.historyList.innerHTML = '<p class="text-red-500 text-sm text-center">Error syncing history.</p>';
            });
        }

        async function saveToHistory(workoutData) {
            if (!user) {
                showToast("Waiting for connection...", "error");
                return;
            }
            if (!db) return;

            try {
                // Add server timestamp
                const dataToSave = {
                    ...workoutData,
                    timestamp: serverTimestamp()
                };
                
                const workoutsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'workouts');
                await addDoc(workoutsRef, dataToSave);
                
                showToast("Workout Saved to Cloud!", "success");
            } catch (error) {
                console.error("Save Error:", error);
                showToast("Failed to save workout.", "error");
            }
        }
        
        // Expose delete function globally for the onclick handler
        window.deleteWorkout = async (id) => {
            if (!user || !db) return;
            if(!confirm("Delete this record permanently?")) return;
            try {
                 await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'workouts', id));
                 showToast("Record deleted", "neutral");
            } catch(e) {
                console.error(e);
                showToast("Error deleting", "error");
            }
        };

        function renderHistoryItem(w) {
            const item = document.createElement('div');
            item.className = "bg-gray-900/80 p-5 rounded-xl border border-gray-800 hover:border-amber-400/50 transition-colors animate-in fade-in slide-in-from-top-2 duration-300 relative group";
            
            const exSummary = w.exercises ? w.exercises.filter(e => e.total > 0).map(e => `${e.total} ${e.name}`).join(', ') : '';
            
            let avgTimeStr = '';
            if(w.roundSplits && w.roundSplits.length > 0) {
               avgTimeStr = `<div class="mt-2 pt-2 border-t border-gray-800 text-xs text-gray-500">Last Round: ${w.roundSplits[w.roundSplits.length-1].time}</div>`;
            }

            item.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-gray-200 text-lg">${w.date}</span>
                    <span class="text-xs bg-gray-800 text-amber-400 px-3 py-1 rounded-full border border-gray-700 font-mono">${w.time}</span>
                </div>
                <div class="flex gap-6 text-sm text-gray-400 mb-3 border-b border-gray-800 pb-3">
                    <span><strong class="text-amber-400 text-lg">${w.totalRounds}</strong> Rounds</span>
                    <span><strong class="text-cyan-400 text-lg">${w.totalReps}</strong> Reps</span>
                </div>
                <p class="text-xs text-gray-500 truncate font-mono">${exSummary || 'No reps recorded'}</p>
                ${avgTimeStr}
                
                <button onclick="window.deleteWorkout('${w.id}')" class="absolute top-4 right-4 text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            `;
            els.historyList.appendChild(item);
            lucide.createIcons();
        }


        // --- Event Listeners ---

        // Auth & Modal
        els.btnLogin.addEventListener('click', openAuthModal);
        els.btnLogout.addEventListener('click', logout);
        els.btnCloseModal.addEventListener('click', closeAuthModal);

        // Close modal when clicking outside
        els.authModal.addEventListener('click', (e) => {
            if (e.target === els.authModal) {
                closeAuthModal();
            }
        });

        // Modal Social Sign-ins
        els.modalGoogleSignin.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            handleSocialSignIn(provider, 'Google');
        });

        els.modalFacebookSignin.addEventListener('click', () => {
            const provider = new FacebookAuthProvider();
            handleSocialSignIn(provider, 'Facebook');
        });

        els.modalMicrosoftSignin.addEventListener('click', () => {
            const provider = new OAuthProvider('microsoft.com');
            handleSocialSignIn(provider, 'Microsoft');
        });

        // Modal Email/Password Signup
        els.modalSignupForm.addEventListener('submit', handleEmailSignup);

        // Timer Mode Toggles
        els.btnModeFortime.addEventListener('click', () => setTimerMode('fortime'));
        els.btnModeAmrap.addEventListener('click', () => setTimerMode('amrap'));
        els.btnModeEmom.addEventListener('click', () => setTimerMode('emom'));
        
        // Timer Inputs
        els.inputAmrapMinutes.addEventListener('change', (e) => {
            state.timer.amrapCap = parseInt(e.target.value) || 10;
            if(!state.timer.isRunning) updateTimerDisplay();
        });
        els.inputEmomInterval.addEventListener('change', (e) => {
            state.timer.emomInterval = parseInt(e.target.value) || 1;
            if(!state.timer.isRunning) updateTimerDisplay();
        });

        // Search & Inputs
        els.inputSearch.addEventListener('input', (e) => handleSearch(e.target.value));
        els.inputSearch.addEventListener('focus', () => { if(els.inputSearch.value) handleSearch(els.inputSearch.value); });
        document.addEventListener('click', (e) => {
            if (!els.inputSearch.contains(e.target) && !els.listSuggestions.contains(e.target)) {
                els.listSuggestions.classList.add('hidden');
            }
        });
        els.btnAdd.addEventListener('click', () => {
            const name = els.inputSearch.value.trim();
            const reps = parseInt(els.inputReps.value) || 10;
            if (name) addExercise(name, reps);
        });
        els.inputSearch.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') els.btnAdd.click();
        });

        // Controls
        els.btnStart.addEventListener('click', startTimer);
        els.btnPause.addEventListener('click', pauseTimer);
        els.btnResetTimer.addEventListener('click', resetTimer);
        els.btnNextRound.addEventListener('click', finishRound);
        els.btnFinish.addEventListener('click', finishWorkout);

        // UI Toggles
        els.btnToggleHistory.addEventListener('click', () => {
            els.historySection.classList.toggle('hidden');
            els.historyArrow.classList.toggle('rotate-180');
        });

        // --- Core Application Logic ---

        function setTimerMode(mode) {
            state.timer.mode = mode;
            
            // Helper to set button active/inactive
            const setActive = (btn, active) => {
                if (active) {
                    btn.classList.add('bg-amber-400', 'text-black', 'shadow-sm');
                    btn.classList.remove('text-gray-500', 'hover:text-gray-300');
                } else {
                    btn.classList.remove('bg-amber-400', 'text-black', 'shadow-sm');
                    btn.classList.add('text-gray-500', 'hover:text-gray-300');
                }
            };

            setActive(els.btnModeFortime, mode === 'fortime');
            setActive(els.btnModeAmrap, mode === 'amrap');
            setActive(els.btnModeEmom, mode === 'emom');

            // Toggle Inputs
            els.groupInputAmrap.classList.add('hidden');
            els.groupInputEmom.classList.add('hidden');
            
            if (mode === 'fortime') {
                els.timerLabel.textContent = "Stopwatch Time";
            } else if (mode === 'amrap') {
                els.groupInputAmrap.classList.remove('hidden');
                els.timerLabel.textContent = "Time Remaining";
            } else if (mode === 'emom') {
                els.groupInputEmom.classList.remove('hidden');
                els.timerLabel.textContent = "Next Interval In";
            }
            
            resetTimer();
        }

        function handleSearch(query) {
            if (!query) {
                els.listSuggestions.classList.add('hidden');
                return;
            }
            const lowerQuery = query.toLowerCase();
            const matches = PREDEFINED_EXERCISES.filter(ex => ex.toLowerCase().includes(lowerQuery));
            els.listSuggestions.innerHTML = '';
            els.listSuggestions.classList.remove('hidden');

            if (matches.length === 0) {
                const li = document.createElement('li');
                li.className = "p-4 hover:bg-gray-800 cursor-pointer text-amber-400 font-semibold border-t border-gray-800";
                li.innerHTML = `<span class="text-xs text-gray-500 block font-normal mb-1">No match found</span>Create "${query}"`;
                li.onclick = () => {
                    els.inputSearch.value = query; 
                    els.listSuggestions.classList.add('hidden');
                    els.inputReps.focus();
                };
                els.listSuggestions.appendChild(li);
            } else {
                matches.forEach(match => {
                    const li = document.createElement('li');
                    li.className = "p-3 hover:bg-gray-800 cursor-pointer text-gray-300 border-b border-gray-800 last:border-0 font-medium";
                    li.textContent = match;
                    li.onclick = () => {
                        els.inputSearch.value = match;
                        els.listSuggestions.classList.add('hidden');
                        els.inputReps.focus();
                    };
                    els.listSuggestions.appendChild(li);
                });
            }
        }

        function addExercise(name, defaultReps) {
            const id = Date.now().toString();
            state.exercises.push({
                id,
                name,
                defaultReps,
                currentReps: defaultReps,
                completed: false,
                totalRepsDone: 0
            });
            els.inputSearch.value = '';
            els.inputReps.value = '10';
            els.listSuggestions.classList.add('hidden');
            renderWorkoutList();
            updateStats();
            showToast(`Added ${name}`, "success");
        }

        function renderWorkoutList() {
            if (state.exercises.length === 0) {
                els.workoutList.innerHTML = '';
                els.workoutList.appendChild(els.emptyState);
                return;
            }
            if (els.workoutList.contains(els.emptyState)) {
                els.workoutList.innerHTML = '';
            }
            els.workoutList.innerHTML = '';

            state.exercises.forEach(ex => {
                const card = document.createElement('div');
                card.className = `exercise-card relative p-5 rounded-xl border-l-4 transition-all duration-300 ${ex.completed ? 'bg-gray-900/40 border-gray-700 opacity-50' : 'bg-gray-800 border-amber-400 shadow-lg'} mb-2 border-t border-r border-b border-gray-700/50`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-xl text-white ${ex.completed ? 'line-through text-gray-500' : ''}">${ex.name}</h3>
                        <button onclick="window.removeExercise('${ex.id}')" class="text-gray-600 hover:text-red-500 transition-colors p-1" title="Remove">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center bg-black/50 rounded-lg p-1 border border-gray-700">
                            <button onclick="window.adjustReps('${ex.id}', -1)" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition-all font-bold text-xl">-</button>
                            <input type="number" readonly value="${ex.currentReps}" class="w-16 text-center bg-transparent font-bold text-2xl text-white focus:outline-none">
                            <button onclick="window.adjustReps('${ex.id}', 1)" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition-all font-bold text-xl">+</button>
                        </div>
                        <button onclick="window.toggleComplete('${ex.id}')" class="flex-1 py-3 px-4 rounded-lg font-bold text-sm uppercase tracking-wider transition-all shadow-md flex justify-center items-center gap-2 ${ex.completed ? 'bg-gray-800 text-green-500 border border-green-900/50' : 'bg-amber-400 text-black hover:bg-white hover:text-black border-none shadow-[0_0_10px_rgba(250,204,21,0.3)]'}">
                            ${ex.completed ? '<i data-lucide="check" class="w-5 h-5"></i> Done' : 'Complete'}
                        </button>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 font-medium text-right uppercase tracking-wider">
                        Total: <span class="text-amber-400 font-bold text-sm">${ex.totalRepsDone}</span> reps
                    </div>
                `;
                els.workoutList.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- Exposing functions to window (for HTML onclick handlers) ---
        window.adjustReps = (id, amount) => {
            const ex = state.exercises.find(e => e.id === id);
            if (ex && !ex.completed) {
                ex.currentReps = Math.max(0, ex.currentReps + amount);
                renderWorkoutList();
            }
        };

        window.toggleComplete = (id) => {
            const ex = state.exercises.find(e => e.id === id);
            if (ex) {
                ex.completed = !ex.completed;
                renderWorkoutList();
                const allDone = state.exercises.every(e => e.completed);
                if (allDone) {
                    els.btnNextRound.classList.add('ring-2', 'ring-offset-2', 'ring-amber-400', 'ring-offset-black', 'bg-amber-400', 'text-black');
                    els.btnNextRound.classList.remove('bg-transparent', 'text-amber-400');
                } else {
                    els.btnNextRound.classList.remove('ring-2', 'ring-offset-2', 'ring-amber-400', 'ring-offset-black', 'bg-amber-400', 'text-black');
                    els.btnNextRound.classList.add('bg-transparent', 'text-amber-400');
                }
            }
        };

        window.removeExercise = (id) => {
            state.exercises = state.exercises.filter(ex => ex.id !== id);
            renderWorkoutList();
            updateStats();
        };

        function finishRound() {
            if (state.exercises.length === 0) {
                showToast("Add exercises first!", "error");
                return;
            }
            let anythingDone = false;
            state.exercises.forEach(ex => {
                if (ex.completed) {
                    ex.totalRepsDone += ex.currentReps;
                    state.accumulatedReps += ex.currentReps;
                    ex.completed = false; 
                    anythingDone = true;
                }
            });
            if (!anythingDone) {
                if(!confirm("No exercises were marked as 'Done'. Advance round anyway?")) return;
            }

            const roundTime = els.timerDisplay.textContent;
            state.roundHistory.push({ round: state.currentRound + 1, time: roundTime });
            
            state.timer.elapsed = 0;
            state.timer.startTime = Date.now();
            updateTimerDisplay();

            state.currentRound++;
            updateStats();
            renderWorkoutList();
            
            els.btnNextRound.classList.remove('ring-2', 'ring-offset-2', 'ring-amber-400', 'ring-offset-black', 'bg-amber-400', 'text-black');
            els.btnNextRound.classList.add('bg-transparent', 'text-amber-400');
            showToast(`Round ${state.currentRound} Complete!`, "success");
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function finishWorkout() {
            if (state.accumulatedReps === 0 && state.currentRound === 0) {
                showToast("Nothing to save!", "error");
                return;
            }
            if(!confirm("Finish and save this workout?")) return;

            pauseTimer();

            const workoutData = {
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                totalRounds: state.currentRound,
                totalReps: state.accumulatedReps,
                exercises: state.exercises.map(e => ({ name: e.name, total: e.totalRepsDone })),
                roundSplits: state.roundHistory
            };

            saveToHistory(workoutData);
            
            state.currentRound = 0;
            state.accumulatedReps = 0;
            state.exercises = [];
            state.roundHistory = [];
            resetTimer();
            renderWorkoutList();
            updateStats();
            els.historySection.classList.remove('hidden');
        }

        function updateStats() {
            els.statRounds.textContent = state.currentRound;
            els.statReps.textContent = state.accumulatedReps;
            els.statCount.textContent = state.exercises.length;
        }

        // --- Timer Logic ---
        function startTimer() {
            if (state.timer.isRunning) return;
            state.timer.startTime = Date.now() - state.timer.elapsed;
            state.timer.interval = setInterval(updateTimerDisplay, 100);
            state.timer.isRunning = true;
            els.btnStart.classList.add('hidden');
            els.btnPause.classList.remove('hidden');
        }

        function pauseTimer() {
            if (!state.timer.isRunning) return;
            clearInterval(state.timer.interval);
            state.timer.elapsed = Date.now() - state.timer.startTime;
            state.timer.isRunning = false;
            els.btnStart.classList.remove('hidden');
            els.btnPause.classList.add('hidden');
        }

        function resetTimer() {
            pauseTimer();
            state.timer.elapsed = 0;
            if (state.timer.mode === 'emom') {
                 els.emomRoundDisplay.textContent = `Interval 1`;
            }
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            let diff;
            if (state.timer.isRunning) {
                diff = Date.now() - state.timer.startTime;
            } else {
                diff = state.timer.elapsed;
            }

            let displayTime = diff;
            let isNegative = false;
            let displayColorClass = 'text-amber-400';

            // MODE SPECIFIC LOGIC
            if (state.timer.mode === 'fortime') {
                // Count UP
                displayTime = diff;
            } 
            else if (state.timer.mode === 'amrap') {
                // Count DOWN from Cap
                const targetMs = state.timer.amrapCap * 60 * 1000;
                let remaining = targetMs - diff;
                
                if (remaining < 0) {
                    isNegative = true;
                    remaining = Math.abs(remaining);
                    displayColorClass = 'text-red-500'; // Overtime
                }
                displayTime = remaining;
            }
            else if (state.timer.mode === 'emom') {
                // Loop based on Interval
                const intervalMs = state.timer.emomInterval * 60 * 1000;
                
                // Calculate which interval we are in
                const currentIntervalIndex = Math.floor(diff / intervalMs) + 1;
                els.emomRoundDisplay.textContent = `Interval ${currentIntervalIndex}`;

                // Calculate time remaining in THIS interval
                let remainingInInterval = intervalMs - (diff % intervalMs);
                
                // When exactly at 0/reset, show full interval
                if (remainingInInterval === intervalMs) remainingInInterval = 0; 

                displayTime = remainingInInterval;
                
                // Visual Alert near end of interval (last 3 seconds)
                if (remainingInInterval < 3100 && state.timer.isRunning) {
                    displayColorClass = 'text-cyan-400';
                }
            }

            // Formatting
            let totalSeconds;
            if (state.timer.mode !== 'fortime') {
                totalSeconds = Math.ceil(displayTime / 1000);
                 // Fix: don't show 60s, show 00s if modulo
                 if (state.timer.mode === 'emom' && totalSeconds === state.timer.emomInterval * 60) totalSeconds = 0;
            } else {
                totalSeconds = Math.floor(displayTime / 1000);
            }
            
            // Edge case for AMRAP hitting 0 exactly
            if (totalSeconds < 0) totalSeconds = 0;

            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            
            const prefix = isNegative ? '-' : '';
            els.timerDisplay.textContent = `${prefix}${minutes}:${seconds}`;
            els.timerDisplay.className = `text-7xl font-mono font-bold tracking-wider mb-6 tabular-nums ${displayColorClass} text-glow cursor-default`;
            document.title = `${prefix}${minutes}:${seconds} - WOD Track`;
        }

        function showToast(message, type = 'normal') {
            const toast = document.createElement('div');
            let colors = "bg-gray-800 text-white border border-gray-700";
            if(type === 'success') colors = "bg-black text-amber-400 border border-amber-400 shadow-[0_0_15px_rgba(250,204,21,0.3)]";
            if(type === 'error') colors = "bg-black text-red-500 border border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)]";
            
            toast.className = `toast ${colors} px-6 py-4 rounded-xl font-bold text-sm flex items-center gap-3 backdrop-blur-md`;
            toast.innerHTML = type === 'success' ? `<i data-lucide="check-circle" class="w-5 h-5"></i> ${message}` : message;
            
            document.getElementById('toast-container').appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
